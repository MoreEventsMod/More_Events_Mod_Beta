namespace = mem_gravekeeper

# 200 GRAVEKEEPER
# Code & idea by Frog, writing by Cc

# ENTER SYSTEM AND INITIAL PROJECT
ship_event = {
	id = mem_gravekeeper.1
	title = "mem_gravekeeper.1"
	desc = "mem_gravekeeper.1.desc"
	picture = GFX_evt_space_station
	location = FROM
	
	is_triggered_only = yes
	
	trigger = {
	    NOT = { has_global_flag = mem_grave_appeared }
		owner = {
			NOT = { has_country_flag = encountered_mem_grave }
			is_ai = no
		}
		FROM = {
			has_star_flag = mem_grave_system
			NOT = { has_star_flag = mem_grave_defeated }
		}
	}
	
	immediate = {
		FROM = { 
			save_event_target_as = mem_gravekeeper_system 
		}
		owner = {
			set_country_flag = encountered_mem_grave
		}
		every_country = {
			if = {
				limit = {
					has_event_chain = "mem_lex_grave_chain" 
				}
				end_event_chain = "mem_lex_grave_chain"
			}
		}
	}		
	
	option = {
		name = "mem_gravekeeper.1.a"
		event_target:mem_gravekeeper_target = {
			enable_special_project = {
				name = "MEM_GRAVE_EXPLORE"
				location = THIS
				owner = ROOT
			}
		}
	}
}

# GRAVEKEEPER STATION SPAWN
ship_event = {
	id = mem_gravekeeper.2
	title = "mem_gravekeeper.2"
	desc = "mem_gravekeeper.2.desc"
	picture = GFX_evt_sentient_AI
	show_sound = event_activating_unknown_technology
	location = THIS
	
	is_triggered_only = yes
	
	trigger = {
		NOT = {
			has_global_flag = mem_grave_toggle
		}
	}
	
	immediate = {
		set_global_flag = mem_grave_toggle
	}
	
	option = {
		name = mem_gravekeeper.2.a
		custom_tooltip = mem_gravekeeper.2.a.tooltip
		owner = { 
			add_physics_research = 1000
			add_society_research = 1000
			add_engineering_research = 1000
		}
		hidden_effect = {
			event_target:mem_gravekeeper_system = {
				random_system_ambient_object = {
					limit = { has_ambient_object_flag = mem_gravekeeper_flag }
					save_event_target_as = mem_gravekeeper_ambient
				}
			}
			create_country = {
				name = "Forlorn"
				type = mem_grave_guardian_passive
				flag = {
					icon = {
						category = "pointy"
						file = "flag_pointy_15.dds"
					}
					background= {
						category = "backgrounds"
						file = "00_solid.dds"
					}
					colors={
						"dark_grey"
						"dark_grey"
						"null"
						"null"
					}
				}
			}
			last_created_country = {
				if = {
					limit = {
						NOT = {
							has_modifier = mem_grave_power
						}
					}
					add_modifier = {
						modifier = mem_grave_power
						days = -1
					}
				}
				save_global_event_target_as = mem_grave_country
				set_country_flag = mem_grave_country
				set_graphical_culture = fallen_empire_04
				guardian_difficulty = yes
			}
			create_fleet = {
				name = "Gravekeeper"
				settings = {
					spawn_debris = no 
					is_boss = yes
				}
				effect = {
					set_owner = event_target:mem_grave_country
					create_ship = {
						name = "Murias"
						design = "Semias"
						graphical_culture = "fallen_empire_04"
						prefix = no
						
						effect = {
							set_disable_at_health = 0.05	
						}
					}
					set_location = event_target:mem_gravekeeper_ambient
					save_global_event_target_as = mem_gravekeeper_spawn
				}
			}
			last_created_fleet = {
				mem_effect_explosion_1 = yes
			}
			owner = { 
				country_event = { id = mem_gravekeeper.10 }
				establish_communications_no_message = event_target:mem_grave_country
			}
			event_target:mem_gravekeeper_ambient = { destroy_ambient_object = this }
		}
	}

	option = {
		name = mem_gravekeeper.2.b
		owner = { 
			add_influence = 100
		}
	}
}

# Gravekeeper Station Activation Followups
country_event = {
	id = mem_gravekeeper.10
	title = "mem_gravekeeper.10"
	desc = "mem_gravekeeper.10.desc"
	picture = GFX_evt_sentient_AI
	location = FROM
	
	is_triggered_only = yes
	
	option = {
		name = "mem_gravekeeper.10.a"
		hidden_effect = {
			country_event = { id = mem_gravekeeper.11 days = 10 }
		}
	}
}

country_event = {
	id = mem_gravekeeper.11
	title = "mem_gravekeeper.11"
	desc = "mem_gravekeeper.11.desc"
	picture = GFX_evt_sentient_AI
	show_sound = event_red_alert
	location = FROM
	
	is_triggered_only = yes
	
	trigger = {
		NOT = {
			has_country_flag = mem_gravekeeper_angered
		}
	}
	
	immediate = {
		every_country = {
			limit = { 
				is_country_type = mem_grave_guardian_passive
			}
			set_country_type = mem_grave_guardian
		}
	}
	
	option = {
		name = WORRYING
	}
}

# GRAVEKEEPER ASSAULT MODE (HIDDEN)
ship_event = {
	id = mem_gravekeeper.20
	hide_window = yes
	
	fire_only_once = yes
	is_triggered_only = yes
	
	trigger = {
		is_ship_size = mem_grave
		OWNER = {
			OR = {
				is_country_type = mem_grave_guardian
				is_country_type = mem_grave_guardian_passive
			}
			has_country_flag = mem_grave_country
		}
	}
	
	immediate = {
	    THIS = {
			solar_system = { 
				save_event_target_as = mem_grave_system 
			}
		}
		create_fleet = {
		name = "Awakened Gravekeeper"
		settings = {
			spawn_debris = no 
			is_boss = yes
		}
		effect = {
			set_owner = event_target:mem_grave_country
			create_ship = {
				name = "Gorias"
				design = "Esras"
				graphical_culture = "fallen_empire_04"
				prefix = no
				
				effect = {
					set_disable_at_health = 0.05	
				}
			}
			set_location = event_target:mem_gravekeeper_spawn
			set_fleet_stance = aggressive
			set_aggro_range_measure_from = self
			set_aggro_range = 50
			
			queue_actions = {	
					repeat = {
						find_closest_planet  = {
							trigger = {
								id = mem_grave_awakened.patrol.1
								has_planet_flag = mem_graveyard_patrol_1
							}
							found_planet = {
								move_to = this
								orbit_planet = this
								wait = {
									duration = 30
								}
							}
						}
						find_closest_planet  = {
							trigger = {
								id = mem_grave_awakened.patrol.2
								has_planet_flag = mem_graveyard_patrol_2
							}
							found_planet = {
								move_to = this
								orbit_planet = this
								wait = {
									duration = 30
								}
							}
						}
						find_closest_planet  = {
							trigger = {
								id = mem_grave_awakened.patrol.3
								has_planet_flag = mem_graveyard_patrol_3
							}
							found_planet = {
								move_to = this
								orbit_planet = this
								wait = {
									duration = 30
								}
							}
						}	
						find_closest_planet  = {
							trigger = {
								id = mem_grave_awakened.patrol.4
								has_planet_flag = mem_graveyard_patrol_4
							}
							found_planet = {
								move_to = this
								orbit_planet = this
								wait = {
									duration = 30
								}
							}
						}	
					}
				}
			}
		}
		last_created_fleet = {
			mem_effect_explosion_2_big = yes
		}
		fleet = {
			delete_fleet = this
		}
		FROM = {
			OWNER = {
				set_country_flag = mem_gravekeeper_angered
				country_event = { id = mem_gravekeeper.21 }
			}
		}
	}
}

# GRAVEKEEPER ASSAULT MODE
country_event = {
	id = mem_gravekeeper.21
	title = "mem_gravekeeper.21"
	desc = "mem_gravekeeper.21.desc"
	picture = GFX_evt_exploding_ship
	show_sound = event_red_alert
	location = event_target:mem_grave_system
	
	is_triggered_only = yes
	
	option = {
		name = "mem_gravekeeper.21.a"
	}
}

# GRAVEKEEPER ESCAPE

fleet_event = {
	id = mem_gravekeeper.22
	hide_window = yes
	
	trigger = {
		any_combatant_fleet = {
			exists = owner
			owner = {
				is_country_type = mem_grave_guardian
			}
			NOT = { 
				has_fleet_flag = mem_grave_ftl_cooldown
			}
			any_owned_ship = {
				is_ship_size = mem_grave_awakened
				has_hp_percentage < 0.25
				has_hp_percentage > 0
			}
		}	
	}
	
	immediate = {
		solar_system = {
				save_event_target_as = mem_grave_escape_loc_1
				random_system_planet = {
					limit = {
						is_star = yes
					}
					mem_effect_explosion_5_big = yes
				}
		}
		random_rim_system = {
			limit = {
				distance = {
					source = event_target:mem_grave_escape_loc_1
					max_distance = 9999
					min_distance = 250
				} 
			}
			random_system_planet = {
				limit = {
					is_star = yes
				}
				mem_effect_explosion_5_big = yes
				save_event_target_as = mem_grave_escape_loc_2
			}
		}
		random_country = {
			limit = {
				has_country_flag = mem_gravekeeper_angered
			}
			country_event = { id = mem_gravekeeper.24 }
		}
		random_combatant_fleet = {
			limit = {
				exists = owner
				owner = {
					is_country_type = mem_grave_guardian
				}
				any_owned_ship = {
					is_ship_size = mem_grave_awakened
				}
			}
			set_location = event_target:mem_grave_escape_loc_2
			fleet_event = { id = mem_gravekeeper.23 }
			set_fleet_flag = mem_grave_track_toggle
			set_timed_fleet_flag = {
				flag = mem_grave_ftl_cooldown
				days = 3600
			}
		}
	}
}

fleet_event = {
	id = mem_gravekeeper.23
	hide_window = yes
	
	is_triggered_only = yes

	immediate = {
		this = {
			owner = {
				random_owned_ship = {
					limit = {
						is_ship_size = mem_grave_awakened 
					}
					save_event_target_as = mem_grave_roaming
				}
			}
			solar_system = {
					save_event_target_as = mem_grave_roam_loc	
			}
		}
		every_country = {
			if = {
				limit = {
					is_ai = no
					NOT = {
						has_event_chain = mem_grave_tracker_chain
					}
				}
				begin_event_chain = {
					event_chain = "mem_grave_tracker_chain"
					target = this
				}
			}
		}
		fleet_event = { id = mem_gravekeeper.25 days = 1800 }
		clear_fleet_actions = this
		queue_actions = {
			repeat = {
				find_random_system = {
					trigger = {
						id = mem_grave_roam.1
						distance = {
							source = event_target:mem_grave_roam_loc
							max_distance = 9999
							min_distance = 250
						}
						NOT = {
							OR = {
								has_star_flag = guardian
								has_star_flag = sanctuary_system
								has_star_flag = mem_ring_system
								has_star_flag = mem_grave_system
								has_star_flag = mem_garden_system
								has_star_flag = mem_prison_system
							}
							any_planet = {
								num_pops > 0
							}
							any_ship_in_system = {
								is_ship_size = mem_grave_awakened 
							}
						}
					}
					found_system = {
						move_to = this
						find_closest_planet = {
							trigger = {
								id =  mem_grave_roam.2
								is_star = yes
							}
							found_planet = {
								orbit_planet = this
								effect = {
									id = mem_grave_roam.3
									save_event_target_as = mem_grave_temp_loc
									event_target:mem_grave_roaming = {
										repair_ship = yes
									}
									every_country = {
										limit = {
											has_event_chain = mem_grave_tracker_chain
										}
										remove_point_of_interest = mem_grave_tracker_poi.1
										create_point_of_interest = {
											id = mem_grave_tracker_poi.1
											name = "mem_grave_tracker_poi"
											desc = "mem_grave_tracker_poi_desc"
											event_chain = mem_grave_tracker_chain
											location = event_target:mem_grave_temp_loc
										}
									}
								}
							}
						}
						wait = {
							duration = 90
							random = 45
						}
					}
				}
			}
		}
	}
}

# Notification - Gravekeeper using emergency ftl

country_event = {
	id = mem_gravekeeper.24
	title = "mem_gravekeeper.24"
	desc = "mem_gravekeeper.24.desc"
	picture = GFX_evt_ship_under_attack
	location = event_target:mem_grave_escape_loc_1
	
	
	is_triggered_only = yes
	
	trigger = {
		NOT = {
			has_country_flag = mem_grave_escape_notification
		}
	}
	
	immediate = {
		set_country_flag = mem_grave_escape_notification
	}
	
	option = {
		name = "mem_gravekeeper.24.a"
	}
}

fleet_event = {
	id = mem_gravekeeper.25
	hide_window = yes
	
	is_triggered_only = yes

	immediate = {
		this = {
			save_event_target_as = mem_gravekeeper_reset
		}
		clear_fleet_actions = this
		queue_actions = {
			find_random_system = {
				trigger = {
					id = mem_grave_return.1
					has_star_flag =	mem_grave_system
				}
				found_system = {
					move_to = this
					find_closest_planet = {
						trigger = {
							id =  mem_grave_return.2
							is_star = yes
						}
						found_planet = {
							move_to = this
							effect = {
								id = mem_grave_return.3
								save_event_target_as = mem_grave_temp_2_loc
								event_target:mem_gravekeeper_reset = {
									fleet_event = { id = mem_gravekeeper.26 }
								}
								every_country = {
									limit = {
										has_event_chain = mem_grave_tracker_chain
									}
									remove_point_of_interest = mem_grave_tracker_poi.1
									create_point_of_interest = {
										id = mem_grave_tracker_poi.1
										name = "mem_grave_tracker_poi"
										desc = "mem_grave_tracker_poi_desc"
										event_chain = mem_grave_tracker_chain
										location = event_target:mem_grave_temp_2_loc
									}
								}
							}
						}
					}
				}
			}
		}
	}
}

fleet_event = {
	id = mem_gravekeeper.26
	hide_window = yes
	
	is_triggered_only = yes

	immediate = {
		clear_fleet_actions = this
		queue_actions = {	
			repeat = {
				find_closest_planet  = {
					trigger = {
						id = mem_grave_awakened.patrol.1a
						has_planet_flag = mem_graveyard_patrol_1
					}
					found_planet = {
						move_to = this
						orbit_planet = this
						wait = {
							duration = 30
						}
					}
				}
				find_closest_planet  = {
					trigger = {
						id = mem_grave_awakened.patrol.2a
						has_planet_flag = mem_graveyard_patrol_2
					}
					found_planet = {
						move_to = this
						orbit_planet = this
						wait = {
							duration = 30
						}
					}
				}
				find_closest_planet  = {
					trigger = {
						id = mem_grave_awakened.patrol.3a
						has_planet_flag = mem_graveyard_patrol_3
					}
					found_planet = {
						move_to = this
						orbit_planet = this
						wait = {
							duration = 30
						}
					}
				}	
				find_closest_planet  = {
					trigger = {
						id = mem_grave_awakened.patrol.4a
						has_planet_flag = mem_graveyard_patrol_4
					}
					found_planet = {
						move_to = this
						orbit_planet = this
						wait = {
							duration = 30
						}
					}
				}	
			}
		}
	}
}

# Gravekeeper Weakness Research

country_event = {
	id = mem_gravekeeper.30
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		OR = {
			is_country_type = mem_grave_guardian
			is_country_type = mem_grave_guardian_passive
		}
		
		from = {
			NOT = {
				has_country_flag = mem_grave_weakness_check
			}
			is_country_type = default
			is_ai = no

			AND = {
				OR = {
					has_technology = "tech_ship_armor_5"
					has_technology = "tech_dragon_armor"
				}
				OR = {
					has_technology = "tech_shields_5"
					has_technology = "tech_psionic_shield"
					has_technology = "tech_enigmatic_deflector"
				}		
				OR = {
					has_technology = "tech_zero_point_power"
					has_technology = "tech_enigmatic_power_core"
				}
				OR = {
					has_technology = "tech_energy_lance_2"
					has_technology = "tech_arc_emitter_2"
					has_technology = "tech_mass_accelerator_2"
				}
			}
		}
	}

	immediate = {
		if = {
			limit = {
				check_variable = {
					which = "mem_grave_kill_counter"
					value < 1
				}
			}
			set_variable = {
				which = "mem_grave_kill_counter"
				value = 1
			}
			else = {
				change_variable = {
					which = "mem_grave_kill_counter"
					value = 1
				}
				if = {
					limit = {
						check_variable = {
							which = "mem_grave_kill_counter"
							value = 100
						}
					}
					from = {
						set_country_flag = mem_grave_weakness_check
						country_event = { id = mem_gravekeeper.31 days = 30 }
					}
				}
			}
		}
	}
}

country_event = {
	id = mem_gravekeeper.31
	title = "mem_gravekeeper.31"
	desc = "mem_gravekeeper.31.desc"
	picture = GFX_evt_exploding_ship
	is_triggered_only = yes

	trigger = {
		NOT = {
			any_country = {
				has_country_flag = mem_grave_slayer
			}
			has_country_flag = mem_grave_weakness_researched 
		}
	}

	option = {
		name = mem_gravekeeper.31.a
		allow = {
			hidden_trigger = {
				NOT = {
					has_modifier = mem_grave_weakness
				}
			}
		}
		capital_scope = {
			save_event_target_as = mem_pc_home 
		}
		hidden_effect = {
			set_country_flag = mem_grave_weakness_researched 
		}
		enable_special_project = {
			name = "MEM_GRAVE_WEAKNESS_PROJECT"
			location = event_target:mem_pc_home
			owner = ROOT
		}
	}
	option = {
		name = mem_gravekeeper.31.b
		add_influence = 100
	}
}

country_event = {
	id = mem_gravekeeper.32
	title = "mem_gravekeeper.32"
	desc = "mem_gravekeeper.32.desc"
	picture = GFX_evt_physics_research
	
	is_triggered_only = yes
	
	trigger = {
		NOT = {
			has_modifier = mem_grave_weakness
		}
	}
	
	option = {
		name = mem_gravekeeper.32.a

		add_modifier = {
			modifier = mem_grave_weakness
			days = -1
		}
	}
}

# GRAVEKEEPER DISABLED (HIDDEN)
ship_event = {
	id = mem_gravekeeper.40
	hide_window = yes
	
	fire_only_once = yes
	is_triggered_only = yes
	
	trigger = {
		is_ship_size = mem_grave_awakened
		OWNER = {
			OR = {
				is_country_type = mem_grave_guardian
				is_country_type = mem_grave_guardian_passive
			}
			has_country_flag = mem_grave_country
		}
		FROM = {
			OWNER = {
				is_ai = no 	
			}
		}
	}
	
	immediate = {
		solar_system = {
			save_event_target_as = mem_grave_system 
		}
		mem_effect_explosion_5_big = yes
		create_ambient_object = {
			type = "mem_gravekeeper_pc_object"
			location = THIS
		}
		last_created_ambient_object = {
			save_global_event_target_as = mem_disabled_gravekeeper_object
		}
		create_ambient_object = {
			type = "large_debris_object"
			location = THIS
		}
		last_created_ambient_object = {
			set_ambient_object_flag = mem_gravekeeper_debris 
		}
		FROM = {
			OWNER = {
				country_event = { id = mem_gravekeeper.41 }
				#mem_ancestor_seal_trigger = yes
				set_country_flag = mem_grave_slayer
				add_threat = {
					who = THIS
					amount = 100
				}
			}
		}
		every_country = {
			if = {
				limit = {
					has_event_chain = "mem_grave_tracker_chain" 
				}
				remove_point_of_interest = mem_grave_tracker_poi.1
				end_event_chain = "mem_grave_tracker_chain"
			}
			if = {
				limit = { 
					has_modifier = mem_grave_weakness
				}
				remove_modifier = "mem_grave_weakness"
			}
			if = {
				limit = {
					has_special_project = MEM_GRAVE_WEAKNESS_PROJECT
				}
				abort_special_project = {
					type = "MEM_GRAVE_WEAKNESS_PROJECT"
					location = capital_scope
				}
			}
		}
		fleet = {
			delete_fleet = this
		}
		event_target:mem_grave_country = {
			destroy_country = yes
		}
		mem_awaken = yes
	}
}

# GRAVEKEEPER DISABLED
country_event = {
	id = mem_gravekeeper.41
	title = "mem_gravekeeper.41"
	desc = "mem_gravekeeper.41.desc"
	picture = GFX_evt_small_space_battle
	location = event_target:mem_grave_system
	
	is_triggered_only = yes
	
	option = {
		name = "mem_gravekeeper.41.a"
		event_target:mem_disabled_gravekeeper_object = {
			enable_special_project = {
				name = "MEM_GRAVE_PC_PROJECT"
				location = THIS
				owner = ROOT
			}
		}
	}
	option = {
		name = "mem_gravekeeper.41.b"
		add_minerals = 10000
		add_energy = 10000
		hidden_effect = {
			event_target:mem_disabled_gravekeeper_object = {
			destroy_ambient_object = this 
			}
			solar_system = {
				random_system_ambient_object = {
					limit = {
						has_ambient_object_flag = mem_gravekeeper_debris 
					}
					
					destroy_ambient_object = this
				}
			}
		}
	}
}

# GRAVEKEEPER DISABLED AI

ship_event = {
	id = mem_gravekeeper.42
	hide_window = yes
	
	fire_only_once = yes
	is_triggered_only = yes
	
	trigger = {
		is_ship_size = mem_grave_awakened
		OWNER = {
			OR = {
				is_country_type = mem_grave_guardian
				is_country_type = mem_grave_guardian_passive
			}
			has_country_flag = mem_grave_country
		}
		FROM = {
			OWNER = {
				is_ai = yes 	
			}
		}
	}
	
	immediate = {
		solar_system = {
			save_event_target_as = mem_grave_system 
		}
		mem_effect_explosion_5_big = yes
		create_ambient_object = {
			type = "large_debris_object"
			location = THIS
		}
		last_created_ambient_object = {
			set_ambient_object_flag = mem_gravekeeper_debris 
		}
		FROM = {
			OWNER = {
				country_event = { id = mem_ancestor.30 days = 1800 }
				country_event = { id = mem_ancestor.30 days = 3600 }
				add_threat = {
					who = THIS
					amount = 100
				}
			}
		}
		every_country = {
			if = {
				limit = {
					has_event_chain = "mem_grave_tracker_chain" 
				}
				remove_point_of_interest = mem_grave_tracker_poi.1
				end_event_chain = "mem_grave_tracker_chain"
			}
			if = {
				limit = { 
					has_modifier = mem_grave_weakness
				}
				remove_modifier = "mem_grave_weakness"
			}
			if = {
				limit = {
					has_special_project = MEM_GRAVE_WEAKNESS_PROJECT
				}
				abort_special_project = {
					type = "MEM_GRAVE_WEAKNESS_PROJECT"
					location = capital_scope
				}
			}
			if = {
				limit = {
					is_ai = no
					is_country_type = default
				}
				country_event = { id = mem_gravekeeper.43 days = 10 }
			}
			country_event = { id = crisis.10 days = 18000 random = 500 }
		}
		fleet = {
			delete_fleet = this
		}
		event_target:mem_grave_country = {
			destroy_country = yes
		}
	}
}

# GRAVEKEEPER DESTRUCTION NOTIFY
country_event = {
	id = mem_gravekeeper.43
	title = "mem_gravekeeper.43"
	desc = "mem_gravekeeper.43.desc"
	picture = GFX_evt_small_space_battle
	location = event_target:mem_grave_system
	
	is_triggered_only = yes
	
	trigger = {
		NOT = {
			has_country_flag = mem_grave_destruction_notify
		}
	}
	
	immediate = {
		set_country_flag = mem_grave_destruction_notify
	}
	
	option = {
		name = "UNFORTUNATE"
	}
}

# GRAVEKEEPER RESTORED
ship_event = {
	id = mem_gravekeeper.50
	title = "mem_gravekeeper.50"
	desc = "mem_gravekeeper.50.desc"
	picture = GFX_evt_ship_in_orbit
	show_sound = event_mystic_reveal
	location = THIS
	
	is_triggered_only = yes
	
	trigger = {
		NOT = {
			owner = {
				has_country_flag = mem_grave_unlock
			}
		}
	}
	
	immediate = {
		owner = {
			save_event_target_as = mem_grave_project_owner 
			add_threat = {
				who = owner 
				amount = 10
			}
			set_country_flag = mem_grave_unlock
		}
	}
	
	option = {
		name = "mem_gravekeeper.50.a"
		create_fleet = {
			name = "Gravekeeper"
			settings = {
				spawn_debris = no 
			}
			effect = {
				set_owner = event_target:mem_grave_project_owner
				create_ship = {
					name = "Finias"
					design = "Fessus"
					graphical_culture = "fallen_empire_04"
					prefix = no
				}
				set_location = {
					target = event_target:mem_disabled_gravekeeper_object
					distance = 0
					angle = random
				}
			}
		}
		hidden_effect = {
			event_target:mem_disabled_gravekeeper_object = {
				destroy_ambient_object = this 
			}
			solar_system = {
				random_system_ambient_object = {
					limit = {
						has_ambient_object_flag = mem_gravekeeper_debris 
					}
					destroy_ambient_object = this
				}
			}
		}
	}
}

# Gravekeeper Enhancement Research
country_event = {
	id = mem_gravekeeper.60
	title = "mem_gravekeeper.60"
	desc = "mem_gravekeeper.60.desc"
	picture = GFX_evt_unspeakable_horror
	
	fire_only_once = yes
	
	trigger = {
		is_ai = no
		is_country_type = default
		has_country_flag = mem_grave_slayer
		any_owned_ship = {
			is_ship_size = mem_grave_awakened_pc_bound
		}
	}
	
	mean_time_to_happen = {
		years = 50

		modifier = {
			factor = 0.5
			has_country_flag = mem_titan_slayer
		}
		
		modifier = {
			factor = 0.5
			has_country_flag = mem_conduit_slayer
		}
		
		modifier = {
			factor = 0.1
			AND = {
				has_country_flag = mem_titan_slayer
				has_country_flag = mem_conduit_slayer
			}
		}
	}
	
	immediate = {
		capital_scope = { save_event_target_as = mem_pc_home }
	}
	
	option = {
		name = "mem_gravekeeper.60.a"
		event_target:mem_pc_home = {
			enable_special_project = {
				name = "MEM_GRAVE_AWAKENING"
				location = THIS
				owner = ROOT
			}
		}
	}
	option = {
		name = "mem_gravekeeper.60.b"
		add_influence = 100
	}
}

country_event = {
	id = mem_gravekeeper.61
	title = "mem_gravekeeper.61"
	desc = "mem_gravekeeper.61.desc"
	picture = GFX_evt_ship_in_orbit
	
	is_triggered_only = yes
	
	trigger = {
			is_ai = no
			is_country_type = default
			has_country_flag = mem_grave_slayer
			NOT = {
				has_country_flag = mem_grave_awakening 
			}
			any_owned_ship = {
				is_ship_size = mem_grave_awakened_pc_bound
			}
		}

	option = {
		name = "mem_gravekeeper.61.a"
		custom_tooltip = mem_gravekeeper.61.a.tooltip
		hidden_effect = {
			set_country_flag = mem_grave_awakening
		}
	}	
}

country_event = {
	id = mem_gravekeeper.70

	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		is_ai = no
		is_country_type = default
		NOT = { has_country_flag = mem_grave_evolve_success }
		has_country_flag = mem_grave_slayer
		has_country_flag = mem_grave_awakening
		any_owned_ship = {
			is_ship_size = mem_grave_awakened_pc_bound
		}
	}
	
	immediate = {
		add_threat = {
			who = THIS
			amount = 10
		}
		FROMFROM = {
			OWNER = {
				save_event_target_as = mem_grave_pc_owner
			}
			save_event_target_as = mem_grave_pc_spawn
		}
		if = {
			limit = {
				FROMFROM = {
					OWNER = {
						count_owned_ships = {
							limit = {
								is_ship_size = mem_grave_awakened_pc_bound
								FLEET = { is_same_value = event_target:mem_grave_pc_spawn }
							}
							count > 0
						}
					}
				}
			}
			create_fleet = {
			name = "Awakened Gravekeeper"
			settings = {
				spawn_debris = no 
			}
			effect = {
				set_owner = event_target:mem_grave_pc_owner
				while = {
					count = 1
					create_ship = {
						name = "Finias"
						design = "Uscias"
						graphical_culture = "fallen_empire_03"
						prefix = no
					}
				}
                set_location = {
					target = event_target:mem_grave_pc_spawn
					distance = 0
					angle = random
					}	
				}
			}
			FROMFROM = {
				delete_fleet = this
			}
			last_created_fleet = {
				mem_effect_explosion_5_big = yes
			}
			set_country_flag = mem_grave_evolve_success
		}
	}
}

country_event = {
	id = mem_gravekeeper.71
	title = "mem_gravekeeper.71"
	desc = "mem_gravekeeper.71.desc"
	picture = GFX_evt_unspeakable_horror
	
	fire_only_once = yes
	
	trigger = {
		is_ai = no
		is_country_type = default
		has_country_flag = mem_grave_slayer
		has_country_flag = mem_grave_awakening
		has_country_flag = mem_grave_evolve_success
		any_owned_ship = {
			is_ship_size = mem_grave_awakened_pc
		}
	}
	
	mean_time_to_happen = {
		years = 50
		
		modifier = {
			factor = 0.75
				any_country = {
					has_country_flag = awakened_fallen_empire
				}	
		}
		modifier = {
			factor = 0.5
				has_global_flag = ai_revolt_happened
		}
		modifier = {
			factor = 0.5
				has_global_flag = prethoryn_invasion_happened
		}
		modifier = {
			factor = 0.5
				has_global_flag = extradimensional_invasion_happened
		}
		modifier = {
			factor = 0.25
				has_global_flag = war_in_heaven_started
		}
		modifier = {
			factor = 0.1
				has_global_flag = mem_ancestor_crisis_start
		}
	}
	
	immediate = {
		capital_scope = { save_event_target_as = mem_pc_home }
	}

	option = {
		name = "mem_gravekeeper.71.a"
		event_target:mem_pc_home = {
			enable_special_project = {
				name = "MEM_GRAVE_LIMIT_BREAK"
				location = THIS
				owner = ROOT
			}
		}
	}
	option = {
		name = "mem_gravekeeper.71.b"
		add_influence = 100
	}
}

country_event = {
	id = mem_gravekeeper.72
	title = "mem_gravekeeper.72"
	desc = "mem_gravekeeper.72.desc"
	picture = GFX_evt_ship_in_orbit
	
	is_triggered_only = yes
	
	trigger = {
			is_ai = no
			is_country_type = default
			has_country_flag = mem_grave_slayer
			has_country_flag = mem_grave_awakening
			has_country_flag = mem_grave_evolve_success
			NOT = {
				has_country_flag = mem_grave_overdrive_unlock 
			}
			any_owned_ship = {
				is_ship_size = mem_grave_awakened_pc
			}
		}

	option = {
		name = "mem_gravekeeper.72.a"
		custom_tooltip = mem_gravekeeper.72.a.tooltip
		hidden_effect = {
			set_country_flag = mem_grave_overdrive_unlock 
		}
	}	
}

fleet_event = {
	id = mem_gravekeeper.73
	hide_window = yes

	trigger = {	
		any_combatant_fleet = {
			exists = owner
			owner = {
				has_country_flag = mem_grave_overdrive_unlock
				NOT = {
					has_country_flag = mem_grave_overdrive_cd_flag
				}
			}
			any_owned_ship = {
				is_ship_size = mem_grave_awakened_pc
				has_hp_percentage < 0.1
				has_hp_percentage > 0
			}
		}
	}
	
	immediate = {
		random_combatant_fleet = {
			limit = {
				exists = owner
				owner = {
					is_ai = no
					is_country_type = default
					has_country_flag = mem_grave_overdrive_unlock
					NOT = {
						has_country_flag = mem_grave_overdrive_cd_flag
					}
				}
				any_owned_ship = {
					is_ship_size = mem_grave_awakened_pc
				}
			}
			this = {
				save_event_target_as = mem_overdrive_fleet_loc
			}
			owner = {
				random_owned_ship = {
					limit = {
						is_ship_size = mem_grave_awakened_pc
					}
					repair_ship = yes
					mem_overdrive = yes
					ship_event = { id = mem_gravekeeper.74 days = 30 }
				}
				country_event = { id = mem_gravekeeper.75 }
				set_timed_country_flag = {
					flag = mem_grave_overdrive_cd_flag
					days = 360
				}
			}
		}
	}
}

ship_event = {
	id = mem_gravekeeper.74
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		this = {
			save_event_target_as = mem_overdrive_cd_loc
		}
		owner = {
			country_event = { id = mem_gravekeeper.76 }
		}
		mem_overdrive_cd = yes
	}
}

country_event = {
	id = mem_gravekeeper.75
	title = "mem_gravekeeper.75"
	desc = "mem_gravekeeper.75.desc"
	picture = GFX_evt_small_space_battle
	location = event_target:mem_overdrive_fleet_loc
	
	is_triggered_only = yes

	option = {
		name = "mem_gravekeeper.75.a"
	}
}

country_event = {
	id = mem_gravekeeper.76
	title = "mem_gravekeeper.76"
	desc = "mem_gravekeeper.76.desc"
	picture = GFX_evt_sentient_AI
	location = event_target:mem_overdrive_cd_loc
	
	is_triggered_only = yes

	option = {
		name = "mem_gravekeeper.76.a"
	}
}
