# Shroud Cult
# By ViolentBeetle

namespace = mem_shroud_cult

# Running into Shroud Cult home system and get triggered
ship_event = {
    id = mem_shroud_cult.1
    title = mem_shroud_cult.1.name
    desc = {
        text = mem_shroud_cult.1.desc
        trigger = {
            owner = {
                is_gestalt = no
            }
        }
    }
    desc = {
        text = mem_shroud_cult.1.machine
        trigger = {
            owner = {
                has_authority = auth_machine_intelligence
            }
        }
    }
    desc = {
        text = mem_shroud_cult.1.hive
        trigger = {
            owner = {
                has_authority = auth_hive_mind
            }
        }
    }

    trigger = {
        exists = event_target:mem_shroud_cult_country
        event_target:mem_shroud_cult_country = {
            is_country_type = mem_shroud_cult_country
        }
        FROM = {
            has_star_flag = mem_shroud_cult_system
            any_ship_in_system = {
                is_owned_by = event_target:mem_shroud_cult_country
            }
        }
        owner = {
            is_country_type = default
            NOT = {
                has_communications = event_target:mem_shroud_cult_country
            }
        }
    }

    diplomatic = yes
    is_triggered_only = yes
    custom_gui = "enclave_caravaneer_window"

    picture_event_data = {
		portrait = event_target:mem_shroud_cult_country
		room = mem_shroud_cult_01_room
    }

    immediate = {
        owner = {
            establish_communications_no_message = event_target:mem_shroud_cult_country
        }
    }

    option = {
		name = SCUM
		exclusive_trigger = {
			owner = {
                has_valid_civic = civic_fanatic_purifiers
            }
		}
		custom_gui = "enclave_caravaneer_option"
	}
	
	option = {
		name = TASTY
		trigger = {
			owner = {
                has_valid_civic = civic_hive_devouring_swarm
            }
		}
		custom_gui = "enclave_caravaneer_option"
	}

	option = {
		name = EXTERMINATE
		trigger = {
			owner = {
                has_valid_civic = civic_machine_terminator
            }
		}
		custom_gui = "enclave_caravaneer_option"
	}

	option = {
		name = leviathans.502.a
		custom_gui = "enclave_caravaneer_option"
	}
}

# Engaging diplomacy, initialization
country_event = {
    id = mem_shroud_cult.2
    is_triggered_only = yes
    hide_window = yes

    trigger = {
        FROM = {
            is_country_type = mem_shroud_cult_country
        }
        NOT = {
            has_country_flag = mem_shroud_cult_diplomacy_engaged
        }
    }

    immediate = {
        remove_country_flag = mem_shroud_cult_cont_convo
        FROM = { save_event_target_as = the_cult_guys }
        if = {
            limit = { is_gestalt = no }
            country_event = { id = mem_shroud_cult.3 }
        }
        else_if = {
            limit = { is_gestalt = yes }
            country_event = { id = mem_shroud_cult.10 }
        }
    }
}

# Engaging custom diplomacy - Cult lobby
country_event = {
    id = mem_shroud_cult.3
    title = mem_shroud_cult.3.name
    desc = {
        text = mem_should_cult.3.desc.0.1
        trigger = {
            NOT = { has_country_flag = mem_shroud_cult_opened_borders }
        }
    }
    desc = {
        text = mem_should_cult.3.desc.0.2
        trigger = {
            NOT = { has_country_flag = mem_shroud_cult_opened_borders }
        }
    }
    desc = {
        text = mem_should_cult.3.desc.1.1
        trigger = {
            has_country_flag = mem_shroud_cult_opened_borders
        }
    }
    desc = {
        text = mem_should_cult.3.desc.1.2
        trigger = {
            has_country_flag = mem_shroud_cult_opened_borders
        }
    }
    # Multiple descs, some coditional
    desc = {
        text = mem_shroud_cult.3.desc.cont
        exclusive_trigger = {
            has_country_flag = mem_shroud_cult_cont_convo
        }
    }

    diplomatic = yes
    is_triggered_only = yes
    custom_gui = "enclave_caravaneer_window"

    picture_event_data = {
		portrait = event_target:the_cult_guys
		room = mem_shroud_cult_01_room
    }

    immediate = {
        set_country_flag = mem_shroud_cult_diplomacy_engaged
    }

    #Open borders
    option = {
        name = mem_shroud_cult.3.a
        custom_gui = "enclave_caravaneer_option"
        custom_tooltip = mem_shroud_cult.3.a.tooltip

        trigger = {
            NOT = { has_country_flag = mem_shroud_cult_opened_borders }
        }

        allow = {
            resource_stockpile_compare = { resource = influence value > 150 }
        }

        add_resource = {
            influence = -150
        }
        add_modifier = {
            modifier = mem_shroud_cult_relations
            days = -1
        }
        custom_tooltip = opinion10
        hidden_effect = {
            event_target:the_cult_guys = {
                add_trust = {
                    who = root
                    amount = 10
                }
            }
        }
        set_country_flag = mem_shroud_cult_opened_borders
        remove_country_flag = mem_shroud_cult_diplomacy_engaged

        ai_chance = {
            factor = 50
            modifier = {
                factor = 0
                resource_stockpile_compare = { resource = influence value < 200 }
            }
            modifier = {
                factor = 0
                resource_income_compare = {
                    resource = influence
                    value < 1.5
                }
            }
        }
        log = "[Root.GetName] opens borders for Cult."
    }

    # Close the borders
    option = {
        name = mem_shroud_cult.3.b
        custom_gui = "enclave_caravaneer_option"
        custom_tooltip = mem_shroud_cult.3.b.tooltip

        trigger = {
            has_country_flag = mem_shroud_cult_opened_borders
        }

        hidden_effect = {
            event_target:the_cult_guys = {
                add_trust = {
                    who = root
                    amount = -100
                }
            }
        }        
        remove_modifier = mem_shroud_cult_relations
        mem_shroud_cult_clear_all_benefits = yes
        remove_country_flag = mem_shroud_cult_opened_borders
        remove_country_flag = mem_shroud_cult_diplomacy_engaged

        ai_chance = {
            factor = 100
            modifier = {
                factor = 0
                resource_income_compare = {
                    resource = influence
                    value > 0.5
                }
            }
        }
        log = "[Root.GetName] closes borders for cult."
    }

    # Request Mercy Corps
    option = {
        name = mem_shroud_cult.3.c
        custom_gui = "enclave_caravaneer_option"

        trigger = {
            has_country_flag = mem_shroud_cult_opened_borders
            NOT = { has_modifier = mem_shroud_cult_mercy_corps }
        }

        allow = {
            # custom_tooltip = {
            #     text = mem_shroud_cult.3.c.fail
            #     event_target:the_cult_guys = {
            #         trust = {
            #             who = root
            #             value > 24
            #         }
            #     }
            # }
        }

        hidden_effect = {
            set_country_flag = mem_shroud_cult_cont_convo
            country_event = { id = mem_shroud_cult.5 }
        }

        ai_chance = {
            factor = 100
        }
        log = "[Root.GetName] goes to Mercy submenu"
    }

    # Request Scholar
    option = {
        name = mem_shroud_cult.3.d
        custom_gui = "enclave_caravaneer_option"

        trigger = {
            has_country_flag = mem_shroud_cult_opened_borders
            NOT = {
                any_owned_leader = { has_leader_flag = mem_shroud_cult_scholar }
            }
        }

        allow = {
            custom_tooltip = {
                fail_text = mem_shroud_cult.3.d.fail
                OR = {
                    event_target:the_cult_guys = {
                        trust = {
                            who = root
                            value > 49
                        }
                    }
                    # any_owned_leader = { has_leader_flag = mem_shroud_cult_scholar }
                }
            }
            # custom_tooltip = {
            #     fail_text = mem_shroud_cult.3.d.norepeat
            #     NOT = {
            #         any_owned_leader = { has_leader_flag = mem_shroud_cult_scholar }
            #     }
            # }
        }

        hidden_effect = {
            set_country_flag = mem_shroud_cult_cont_convo
            country_event = { id = mem_shroud_cult.7 }
        }

        ai_chance = {
            factor = 10
        }
        log = "[Root.GetName] goes to Scholar submenu"
    }

    option = {
        name = mem_shroud_cult.3.e
        custom_gui = "enclave_caravaneer_option"

        trigger = {
            has_country_flag = mem_shroud_cult_opened_borders
            NOT = { has_country_flag = mem_shroud_cult_bought_a_sermon }
        }

        allow = {
            custom_tooltip = {
                fail_text = mem_shroud_cult.3.e.fail
                event_target:the_cult_guys = {
                    trust = {
                        who = root
                        value > 99
                    }
                }
            }
        }

        hidden_effect = {
            set_country_flag = mem_shroud_cult_cont_convo
            country_event = { id = mem_shroud_cult.8 }
        }

        ai_chance = {
            factor = 15
        }
        log = "[Root.GetName] goes to Sermon submenu"
    }

    option = {
        name = mem_shroud_cult.3.more
        custom_gui = "enclave_caravaneer_option"

        hidden_effect = {
            set_country_flag = mem_shroud_cult_cont_convo
            country_event = { id = mem_shroud_cult.4 }
        }

        ai_chance = {
            factor = 0
        }
        log = "[Root.GetName] goes to More Info submenu (This is not OK for AI to do!)"
    }

    # farewell
    option = {
        name = mem_shroud_cult.3.farewell
        custom_gui = "enclave_caravaneer_option"
        remove_country_flag = mem_shroud_cult_diplomacy_engaged

        ai_chance = {
            factor = 25
        }
        log = "[Root.GetName] leaves the convo"
    }

    # Why is your station on fire
    option = {
        name = mem_shroud_cult.3.hams
        custom_gui = "enclave_caravaneer_option"
        is_dialog_only = yes
        response_text = mem_shroud_cult.3.hams.response

        trigger = {
            NOT = { has_country_flag = mem_shroud_cult_asked_about_smoke }
        }
        set_country_flag = mem_shroud_cult_asked_about_smoke
        ai_chance = {
            factor = 0
        }
        log = "[Root.GetName] asked about smoke (This is not OK for AI to do!)"
    }

    # Purifier lockdown
    option = {
		name = SCUM
		exclusive_trigger = {
			owner = {
                has_valid_civic = civic_fanatic_purifiers
            }
		}
		custom_gui = "enclave_caravaneer_option"
        remove_country_flag = mem_shroud_cult_diplomacy_engaged
        ai_chance = {
            factor = 1000
        }
        log = "[Root.GetName] ragequits"
	}

    # Cheat
    option = {
        name = mem_shroud_cult.3.xxx
        custom_gui = "enclave_caravaneer_option"
        is_dialog_only = yes
        response_text = mem_shroud_cult.3.xxx.response
        custom_tooltip = opinion10
        hidden_effect = {
            event_target:the_cult_guys = {
                add_trust = {
                    who = root
                    amount = 10
                }
            }
        }
        ai_chance = {
            factor = 0
        }
    }
}

# Faith questionarrie
country_event = {
    id = mem_shroud_cult.4
    title = mem_shroud_cult.3.name
    desc = mem_shroud_cult.4.desc

    diplomatic = yes
    is_triggered_only = yes
    custom_gui = "enclave_caravaneer_window"

    picture_event_data = {
		portrait = event_target:the_cult_guys
		room = mem_shroud_cult_01_room
    }

    option = {
        name = mem_shroud_cult.4.a
        is_dialog_only = yes
        response_text = mem_shroud_cult.4.a.response
        custom_gui = "enclave_caravaneer_option"
        ai_chance = {
            factor = 0
        }
    }
    option = {
        name = mem_shroud_cult.4.b
        is_dialog_only = yes
        response_text = mem_shroud_cult.4.b.response
        custom_gui = "enclave_caravaneer_option"
        ai_chance = {
            factor = 0
        }
    }
    option = {
        name = mem_shroud_cult.4.c
        is_dialog_only = yes
        response_text = mem_shroud_cult.4.c.response
        custom_gui = "enclave_caravaneer_option"
        ai_chance = {
            factor = 0
        }
    }

    option = {
        name = mem_shroud_cult.4.return
        custom_gui = "enclave_caravaneer_option"
        hidden_effect = {
            country_event = {
                id = mem_shroud_cult.3
            }
        }
        ai_chance = {
            factor = 0
        }
    }

    option = {
        name = mem_shroud_cult.3.farewell
        custom_gui = "enclave_caravaneer_option"
        remove_country_flag = mem_shroud_cult_diplomacy_engaged
        ai_chance = {
            factor = 100
        }
    }
}

@mercy_modifier_length = 1800
@mercy_subversion_mana = 50

# Request mercy corps
country_event = {
    id = mem_shroud_cult.5
    title = mem_shroud_cult.3.name
    desc = mem_shroud_cult.5.desc

    diplomatic = yes
    is_triggered_only = yes
    custom_gui = "enclave_caravaneer_window"

    picture_event_data = {
		portrait = event_target:the_cult_guys
		room = mem_shroud_cult_01_room
    }

    option = {
        name = mem_shroud_cult.5.a
        custom_gui = "enclave_caravaneer_option"
        trigger = {
            num_owned_planets < 5
        }
        allow = {
            resource_stockpile_compare = {
                resource = energy
                value >= 1000                
            }
        }
        add_resource = {
            energy = -1000
        }
        custom_tooltip = opinion20
        hidden_effect = {
            event_target:the_cult_guys = {
                add_trust = {
                    who = root
                    amount = 20
                }
            }
        }
        add_modifier = {
            modifier = mem_shroud_cult_mercy_corps
            days = @mercy_modifier_length
        }
        hidden_effect = {
            change_variable = {
                which = mem_shroud_cult_subversion_mana
                value = @mercy_subversion_mana
            }
            set_country_flag = mem_shroud_cult_hired_corps
            country_event = {
                id = mem_shroud_cult.6 # Request for a repeat
                days = @mercy_modifier_length
            }
        }
        remove_country_flag = mem_shroud_cult_diplomacy_engaged

        ai_chance = {
            factor = 100
            modifier = {
                factor = 0
                resource_income_compare = {
                    resource = energy
                    value < 20
                }
            }
        }
        log = "[Root.GetName] bought Mercy for 1000"
    }

    option = {
        name = mem_shroud_cult.5.a
        custom_gui = "enclave_caravaneer_option"
        trigger = {
            num_owned_planets < 10
            num_owned_planets > 4
        }
        allow = {
            resource_stockpile_compare = {
                resource = energy
                value >= 2000                
            }
        }
        add_resource = {
            energy = -2000
        }
        custom_tooltip = opinion20
        hidden_effect = {
            event_target:the_cult_guys = {
                add_trust = {
                    who = root
                    amount = 20
                }
            }
        }
        add_modifier = {
            modifier = mem_shroud_cult_mercy_corps
            days = @mercy_modifier_length
        }
        hidden_effect = {
            change_variable = {
                which = mem_shroud_cult_subversion_mana
                value = @mercy_subversion_mana
            }
            set_country_flag = mem_shroud_cult_hired_corps
            country_event = {
                id = mem_shroud_cult.6 # Request for a repeat
                days = @mercy_modifier_length
            }
        }
        remove_country_flag = mem_shroud_cult_diplomacy_engaged
        ai_chance = {
            factor = 100
            modifier = {
                factor = 0
                resource_income_compare = {
                    resource = energy
                    value < 20
                }
            }
        }
        log = "[Root.GetName] bought Mercy for 2000"
    }

    option = {
        name = mem_shroud_cult.5.a
        custom_gui = "enclave_caravaneer_option"
        trigger = {
            num_owned_planets < 15
            num_owned_planets > 9
        }
        allow = {
            resource_stockpile_compare = {
                resource = energy
                value >= 3000                
            }
        }
        add_resource = {
            energy = -3000
        }        
        custom_tooltip = opinion20
        hidden_effect = {
            event_target:the_cult_guys = {
                add_trust = {
                    who = root
                    amount = 20
                }
            }
        }
        add_modifier = {
            modifier = mem_shroud_cult_mercy_corps
            days = @mercy_modifier_length
        }
        hidden_effect = {
            change_variable = {
                which = mem_shroud_cult_subversion_mana
                value = @mercy_subversion_mana
            }
            set_country_flag = mem_shroud_cult_hired_corps
            country_event = {
                id = mem_shroud_cult.6 # Request for a repeat
                days = @mercy_modifier_length
            }
        }
        remove_country_flag = mem_shroud_cult_diplomacy_engaged

        ai_chance = {
            factor = 100
            modifier = {
                factor = 0
                resource_income_compare = {
                    resource = energy
                    value < 20
                }
            }
        }
        log = "[Root.GetName] bought Mercy for 3000"
    }

    option = {
        name = mem_shroud_cult.5.a
        custom_gui = "enclave_caravaneer_option"
        trigger = {
            num_owned_planets < 20
            num_owned_planets > 14
        }
        allow = {
            resource_stockpile_compare = {
                resource = energy
                value >= 4000                
            }
        }
        add_resource = {
            energy = -4000
        }
        custom_tooltip = opinion20
        hidden_effect = {
            event_target:the_cult_guys = {
                add_trust = {
                    who = root
                    amount = 20
                }
            }
        }
        add_modifier = {
            modifier = mem_shroud_cult_mercy_corps
            days = @mercy_modifier_length
        }
        hidden_effect = {
            change_variable = {
                which = mem_shroud_cult_subversion_mana
                value = @mercy_subversion_mana
            }
            set_country_flag = mem_shroud_cult_hired_corps
            country_event = {
                id = mem_shroud_cult.6 # Request for a repeat
                days = @mercy_modifier_length
            }
        }
        remove_country_flag = mem_shroud_cult_diplomacy_engaged

        ai_chance = {
            factor = 100
            modifier = {
                factor = 0
                resource_income_compare = {
                    resource = energy
                    value < 20
                }
            }
        }
        log = "[Root.GetName] bought Mercy for 4000"
    }

    option = {
        name = mem_shroud_cult.5.a
        custom_gui = "enclave_caravaneer_option"
        trigger = {
            num_owned_planets > 19
        }
        allow = {
            resource_stockpile_compare = {
                resource = energy
                value >= 5000                
            }
        }
        add_resource = {
            energy = -5000
        }
        custom_tooltip = opinion20
        hidden_effect = {
            event_target:the_cult_guys = {
                add_trust = {
                    who = root
                    amount = 20
                }
            }
        }
        add_modifier = {
            modifier = mem_shroud_cult_mercy_corps
            days = @mercy_modifier_length
        }
        hidden_effect = {
            change_variable = {
                which = mem_shroud_cult_subversion_mana
                value = @mercy_subversion_mana
            }
            set_country_flag = mem_shroud_cult_hired_corps
            country_event = {
                id = mem_shroud_cult.6 # Request for a repeat
                days = @mercy_modifier_length
            }
        }
        remove_country_flag = mem_shroud_cult_diplomacy_engaged

        ai_chance = {
            factor = 100
            modifier = {
                factor = 0
                resource_income_compare = {
                    resource = energy
                    value < 20
                }
            }
        }
        log = "[Root.GetName] bought Mercy for 5000"
    }

    option = {
        name = mem_shroud_cult.4.return
        custom_gui = "enclave_caravaneer_option"
        hidden_effect = {
            country_event = {
                id = mem_shroud_cult.3
            }
        }

        ai_chance = {
            factor = 0
        }
    }

    option = {
        name = mem_shroud_cult.5.b
        custom_gui = "enclave_caravaneer_option"
        remove_country_flag = mem_shroud_cult_diplomacy_engaged

        ai_chance = {
            factor = 33
        }
        log = "[Root.GetName] did not buy Mercy Corps"
    }
}

# Offer to renew corpse services.
country_event = {
    id = mem_shroud_cult.6
    title = mem_shroud_cult.3.name
    desc = mem_shroud_cult.6.desc

    diplomatic = yes
    is_triggered_only = yes
    custom_gui = "enclave_caravaneer_window"

    picture_event_data = {
		portrait = event_target:the_cult_guys
		room = mem_shroud_cult_01_room
    }

    trigger = {
        is_ai = no
        exists = event_target:the_cult_guys
        event_target:the_cult_guys = {
            is_country_type = mem_shroud_cult_country
            NOT = { has_country_flag = mem_shroud_cult_final_preparations }
        }
        # This code is wonky, but shouldn't be exploitable
        NOT = { has_modifier = mem_shroud_cult_mercy_corps }
        has_country_flag = mem_shroud_cult_opened_borders
    }

    option = {
        name = mem_shroud_cult.5.a
        custom_gui = "enclave_caravaneer_option"
        trigger = {
            num_owned_planets < 5
        }
        allow = {
            resource_stockpile_compare = {
                resource = energy
                value >= 1000                
            }
        }
        add_resource = {
            energy = -1000
        }
        custom_tooltip = opinion20
        hidden_effect = {
            event_target:the_cult_guys = {
                add_trust = {
                    who = root
                    amount = 20
                }
            }
        }
        add_modifier = {
            modifier = mem_shroud_cult_mercy_corps
            days = @mercy_modifier_length
        }
        hidden_effect = {
            change_variable = {
                which = mem_shroud_cult_subversion_mana
                value = @mercy_subversion_mana
            }
            set_country_flag = mem_shroud_cult_hired_corps
            country_event = {
                id = mem_shroud_cult.6 # Request for a repeat
                days = @mercy_modifier_length
            }
        }
    }

    option = {
        name = mem_shroud_cult.5.a
        custom_gui = "enclave_caravaneer_option"
        trigger = {
            num_owned_planets < 10
            num_owned_planets > 4
        }
        allow = {
            resource_stockpile_compare = {
                resource = energy
                value >= 2000                
            }
        }
        add_resource = {
            energy = -2000
        }
        custom_tooltip = opinion20
        hidden_effect = {
            event_target:the_cult_guys = {
                add_trust = {
                    who = root
                    amount = 20
                }
            }
        }
        add_modifier = {
            modifier = mem_shroud_cult_mercy_corps
            days = @mercy_modifier_length
        }
        hidden_effect = {
            change_variable = {
                which = mem_shroud_cult_subversion_mana
                value = @mercy_subversion_mana
            }
            set_country_flag = mem_shroud_cult_hired_corps
            country_event = {
                id = mem_shroud_cult.6 # Request for a repeat
                days = @mercy_modifier_length
            }
        }
    }

    option = {
        name = mem_shroud_cult.5.a
        custom_gui = "enclave_caravaneer_option"
        trigger = {
            num_owned_planets < 15
            num_owned_planets > 9
        }
        allow = {
            resource_stockpile_compare = {
                resource = energy
                value >= 3000                
            }
        }
        add_resource = {
            energy = -3000
        }        
        custom_tooltip = opinion20
        hidden_effect = {
            event_target:the_cult_guys = {
                add_trust = {
                    who = root
                    amount = 20
                }
            }
        }
        add_modifier = {
            modifier = mem_shroud_cult_mercy_corps
            days = @mercy_modifier_length
        }
        hidden_effect = {
            change_variable = {
                which = mem_shroud_cult_subversion_mana
                value = @mercy_subversion_mana
            }
            set_country_flag = mem_shroud_cult_hired_corps
            country_event = {
                id = mem_shroud_cult.6 # Request for a repeat
                days = @mercy_modifier_length
            }
        }
    }

    option = {
        name = mem_shroud_cult.5.a
        custom_gui = "enclave_caravaneer_option"
        trigger = {
            num_owned_planets < 20
            num_owned_planets > 14
        }
        allow = {
            resource_stockpile_compare = {
                resource = energy
                value >= 4000                
            }
        }
        add_resource = {
            energy = -4000
        }
        custom_tooltip = opinion20
        hidden_effect = {
            event_target:the_cult_guys = {
                add_trust = {
                    who = root
                    amount = 20
                }
            }
        }
        add_modifier = {
            modifier = mem_shroud_cult_mercy_corps
            days = @mercy_modifier_length
        }
        hidden_effect = {
            change_variable = {
                which = mem_shroud_cult_subversion_mana
                value = @mercy_subversion_mana
            }
            set_country_flag = mem_shroud_cult_hired_corps
            country_event = {
                id = mem_shroud_cult.6 # Request for a repeat
                days = @mercy_modifier_length
            }
        }
    }

    option = {
        name = mem_shroud_cult.5.a
        custom_gui = "enclave_caravaneer_option"
        trigger = {
            num_owned_planets > 19
        }
        allow = {
            resource_stockpile_compare = {
                resource = energy
                value >= 5000                
            }
        }
        add_resource = {
            energy = -5000
        }
        custom_tooltip = opinion20
        hidden_effect = {
            event_target:the_cult_guys = {
                add_trust = {
                    who = root
                    amount = 20
                }
            }
        }
        add_modifier = {
            modifier = mem_shroud_cult_mercy_corps
            days = @mercy_modifier_length
        }
        hidden_effect = {
            change_variable = {
                which = mem_shroud_cult_subversion_mana
                value = @mercy_subversion_mana
            }
            set_country_flag = mem_shroud_cult_hired_corps
            country_event = {
                id = mem_shroud_cult.6 # Request for a repeat
                days = @mercy_modifier_length
            }
        }
    }

    option = {
        name = mem_shroud_cult.5.b
        custom_gui = "enclave_caravaneer_option"
    }
}

# Hiring Shroud Scholar
country_event = {
    id = mem_shroud_cult.7
    title = mem_shroud_cult.3.name
    desc = mem_shroud_cult.7.desc

    diplomatic = yes
    is_triggered_only = yes
    custom_gui = "enclave_caravaneer_window"

    picture_event_data = {
		portrait = event_target:the_cult_guys
		room = mem_shroud_cult_01_room
    }

    option = {
        name = mem_shroud_cult.7.a
        custom_gui = "enclave_caravaneer_option"
        allow = {
            resource_stockpile_compare = {
                resource = energy
                value >= 5000                
            }
        }
        add_resource = {
            energy = -5000
        }        
        custom_tooltip = opinion20
        hidden_effect = {
            event_target:the_cult_guys = {
                add_trust = {
                    who = root
                    amount = 20
                }
            }
        }
        custom_tooltip = mem_shroud_cult.7.a.tooltip
        hidden_effect = {
            change_variable = {
                which = mem_shroud_cult_subversion_mana
                value = 200
            }
            create_leader = {
                class = scientist
                sub_type = society
                species = event_target:the_cult_guys.species
                event_leader = yes
                skill = 2
                effect = {
                    add_trait = leader_trait_expertise_psionics
                    set_leader_flag = mem_shroud_cult_scholar
                }
            }
        }
        remove_country_flag = mem_shroud_cult_diplomacy_engaged

        ai_chance = {
            factor = 50
            modifier = {
                factor = 0
                resource_stockpile_compare = {
                    resource = energy
                    value < 6000
                }
            }
        }
        log = "[Root.GetName] bought Scholar"
    }

    option = {
        name = mem_shroud_cult.4.return
        custom_gui = "enclave_caravaneer_option"
        hidden_effect = {
            country_event = {
                id = mem_shroud_cult.3
            }
        }
        ai_chance = {
            factor = 0
        }
    }

    option = {
        name = mem_shroud_cult.7.b
        custom_gui = "enclave_caravaneer_option"
        remove_country_flag = mem_shroud_cult_diplomacy_engaged
        ai_chance = {
            factor = 100
        }
    }
}

country_event = {
    id = mem_shroud_cult.8
    title = mem_shroud_cult.3.name
    desc = mem_shroud_cult.8.desc

    diplomatic = yes
    is_triggered_only = yes
    custom_gui = "enclave_caravaneer_window"

    picture_event_data = {
		portrait = event_target:the_cult_guys
		room = mem_shroud_cult_01_room
    }

    option = {
        name = mem_shroud_cult.8.a
        custom_gui = "enclave_caravaneer_option"
        allow = {
            resource_stockpile_compare = {
                resource = energy
                value >= 5000                
            }
        }
        add_resource = {
            energy = -5000
        }        
        custom_tooltip = opinion20
        hidden_effect = {
            event_target:the_cult_guys = {
                add_trust = {
                    who = root
                    amount = 20
                }
            }
        }
        custom_tooltip = mem_shroud_cult.8.a.tooltip
        hidden_effect = {
            change_variable = {
                which = mem_shroud_cult_subversion_mana
                value = 500
            }
            set_country_flag = mem_shroud_cult_bought_a_sermon
            random_list = {
                1 = { set_country_flag = mem_shroud_cult_sermon_of_life }
                1 = { set_country_flag = mem_shroud_cult_sermon_of_joy }
                1 = { set_country_flag = mem_shroud_cult_sermon_of_fortitude }
                1 = { set_country_flag = mem_shroud_cult_sermon_of_knowledge }
                1 = { set_country_flag = mem_shroud_cult_sermon_of_labour }
                1 = { set_country_flag = mem_shroud_cult_sermon_of_ingenuity }
                1 = { set_country_flag = mem_shroud_cult_sermon_of_prosperity }
            }
            country_event = { id = mem_shroud_cult.9 }
        }

        ai_chance = {
            factor = 100
            modifier = {
                factor = 0
                resource_stockpile_compare = {
                    resource = energy
                    value < 6000
                }
            }
        }
        log = "[Root.GetName] bought Semon"
    }

    option = {
        name = mem_shroud_cult.4.return
        custom_gui = "enclave_caravaneer_option"
        hidden_effect = {
            country_event = {
                id = mem_shroud_cult.3
            }
        }

        ai_chance = {
            factor = 0
        }
    }

    option = {
        name = mem_shroud_cult.8.b
        custom_gui = "enclave_caravaneer_option"
        remove_country_flag = mem_shroud_cult_diplomacy_engaged

        ai_chance = {
            factor = 100
        }
        log = "[Root.GetName] didn't but Sermon"
    }
}

# Sermon results
country_event = {
    id = mem_shroud_cult.9
    title = mem_shroud_cult.3.name
    desc = {
        text = mem_shroud_cult.9.desc.life
        trigger = {
            has_country_flag = mem_shroud_cult_sermon_of_life
        }
    }
    desc = {
        text = mem_shroud_cult.9.desc.joy
        trigger = {
            has_country_flag = mem_shroud_cult_sermon_of_joy
        }
    }
    desc = {
        text = mem_shroud_cult.9.desc.fortitude
        trigger = {
            has_country_flag = mem_shroud_cult_sermon_of_fortitude
        }
    }
    desc = {
        text = mem_shroud_cult.9.desc.knowledge
        trigger = {
            has_country_flag = mem_shroud_cult_sermon_of_knowledge
        }
    }
    desc = {
        text = mem_shroud_cult.9.desc.labour
        trigger = {
            has_country_flag = mem_shroud_cult_sermon_of_labour
        }
    }
    desc = {
        text = mem_shroud_cult.9.desc.ingenuity
        trigger = {
            has_country_flag = mem_shroud_cult_sermon_of_ingenuity
        }
    }
    desc = {
        text = mem_shroud_cult.9.desc.prosperity
        trigger = {
            has_country_flag = mem_shroud_cult_sermon_of_prosperity
        }
    }

    diplomatic = yes
    is_triggered_only = yes
    custom_gui = "enclave_caravaneer_window"

    picture_event_data = {
		portrait = event_target:the_cult_guys
		room = mem_shroud_cult_01_room
    }

    option = {
        name = mem_shroud_cult.9.a
        custom_tooltip = mem_shroud_cult.9.a.tooltip
        custom_gui = "enclave_caravaneer_option"
        remove_country_flag = mem_shroud_cult_diplomacy_engaged
    }
}

country_event = {
    id = mem_shroud_cult.10
    title = mem_shroud_cult.3.name
    desc = {
        text = mem_shroud_cult.10.machine
        trigger = {
            owner = {
                has_authority = auth_machine_intelligence
            }
        }
    }
    desc = {
        text = mem_shroud_cult.10.hive
        trigger = {
            owner = {
                has_authority = auth_hive_mind
            }
        }
    }

    diplomatic = yes
    is_triggered_only = yes
    custom_gui = "enclave_caravaneer_window"

    picture_event_data = {
		portrait = event_target:the_cult_guys
		room = mem_shroud_cult_01_room
    }

    immediate = {
        set_country_flag = mem_shroud_cult_diplomacy_engaged
    }

    option = {
		name = TASTY
		trigger = {
			owner = {
                has_valid_civic = civic_hive_devouring_swarm
            }
		}
		custom_gui = "enclave_caravaneer_option"
	}

	option = {
		name = EXTERMINATE
		trigger = {
			owner = {
                has_valid_civic = civic_machine_terminator
            }
		}
		custom_gui = "enclave_caravaneer_option"
	}

	option = {
		name = mem_shroud_cult.10.a
		custom_gui = "enclave_caravaneer_option"
	}

    after = {
        remove_country_flag = mem_shroud_cult_diplomacy_engaged
    }
}

# Gain opinion and subversion mana. Run AI purchase loop
event = {
    id = mem_shroud_cult.11
    hide_window = yes
    is_triggered_only = yes

    trigger = {
        exists = event_target:mem_shroud_cult_country
        event_target:mem_shroud_cult_country = {
            is_country_type = mem_shroud_cult_country
        }
    }

    immediate = {
        every_country = {
            limit = { has_country_flag = mem_shroud_cult_opened_borders }
            event_target:mem_shroud_cult_country = {
                add_trust = {
                    amount = 1
                    who = prev
                }
            }
            change_variable = {
                which = mem_shroud_cult_subversion_mana
                value = 1                
            }
        }
        event_target:mem_shroud_cult_country = {
            every_neighbor_country = {
                limit = {
                    is_country_type = default
                    is_gestalt = no
                }
            }
            change_variable = {
                which = mem_shroud_cult_subversion_mana
                value = 1                
            }
            save_event_target_as = the_cult_guys
            every_relation = {
                limit = {
                    is_ai = yes
                    is_country_type = default
                    is_gestalt = no
                    is_xenophobe = no
                    is_materialist = no
                    NOT = { has_valid_civic = civic_fanatic_purifiers }
                }
                country_event = {
                    id = mem_shroud_cult.3
                }
            }
        }
    }
}

# Clear modifiers on owner change
planet_event = {
    id = mem_shroud_cult.12
    hide_window = yes
    is_triggered_only = yes

    trigger = {
        mem_shroud_cult_has_sermon = yes
    }

    immediate = {
        mem_shroud_cult_clear_sermons = yes
    }
}

# AI decision-making loop - will re-instate if necessary
# country_event = {
#     id = mem_shroud_cult.13
#     hide_window = yes
#     is_triggered_only = yes

#     # AI will not consider a deal if its ethics are not compatible
#     trigger = {
#         is_xenophobe = no
#         is_materialist = no
#         is_gestalt = no
#     }

#     immediate = {
#         log = "[Root.GetName] considers what do do."
#         if = {
#             limit = {
#                 NOT = { has_country_flag = mem_shroud_cult_opened_borders }
#             }
#             log = "[Root.GetName] considers if it wants to open borders"
#             if = {
#                 limit = {
#                     resource_stockpile_compare = {
#                         resource = influence
#                         value > 300
#                     }
#                     resource_income_compare = {
#                         resource = influence
#                         value > 1.5
#                     }
#                 }
#                 random_list = {
#                     1 = {
#                         add_modifier = { modifier = mem_shroud_cult_relations days = -1 }
#                         set_country_flag = mem_shroud_cult_opened_borders
#                         add_resource = { influence = -200 } # AI is a cheater and gets a discount I guess
#                         log = "[Root.GetName] opened borders."
#                     }
#                     3 = {
#                         log = "[Root.GetName] did not open borders."
#                         modifier = {
#                             factor = 3
#                             is_spiritualist = no
#                             is_xenophile = no
#                         }
#                     }
#                 }
#             }
#         }
#         else_if = {
#             limit = {
#                 resource_income_compare = {
#                     resource = influence
#                     value < 0.25
#                 }
#             }
#             log = "[Root.GetName] cancelled access."
#             remove_modifier = mem_shroud_cult_relations
#             mem_shroud_cult_clear_all_benefits = yes
#             remove_country_flag = mem_shroud_cult_opened_borders
#         }
#         else_if = {
#             limit = {
#                 has_modifier = mem_shroud_cult_mercy_corps
#                 resource_stockpile_compare = {
#                     resource = energy
#                     value > 6000
#                 }
#                 event_target:mem_shroud_cult_country = {
#                     trust = {
#                         who = root
#                         value > 49
#                     }
#                 }
#             }
#             random_list = {
#                 3 = {
#                     add_resource = {
#                         energy = -5000
#                     }
#                     event_target:mem_shroud_cult_country = {
#                         add_trust = {
#                             who = root
#                             amount = 20
#                         }
#                     }
#                     change_variable = {
#                         which = mem_shroud_cult_subversion_mana
#                         value = 200
#                     }
#                     create_leader = {
#                         class = scientist
#                         sub_type = society
#                         species = event_target:mem_shroud_cult_country.species
#                         event_leader = yes
#                         skill = 2
#                         effect = {
#                             add_trait = leader_trait_expertise_psionics
#                             set_leader_flag = mem_shroud_cult_scholar
#                         }
#                     }
#                     modifier = {
#                         factor = 0
#                         any_owned_leader = {
#                             OR = {
#                                 has_leader_flag = mem_shroud_cult_scholar
#                                 has_trait = leader_trait_expertise_psionics
#                             }
#                         }
#                     }

#                     log = "[Root.GetName] bought a scholar"
#                 }
#                 3 = {
#                     change_variable = {
#                         which = mem_shroud_cult_subversion_mana
#                         value = 500
#                     }
#                     set_country_flag = mem_shroud_cult_bought_a_sermon
#                     random_list = {
#                         1 = { set_country_flag = mem_shroud_cult_sermon_of_life }
#                         1 = { set_country_flag = mem_shroud_cult_sermon_of_joy }
#                         1 = { set_country_flag = mem_shroud_cult_sermon_of_fortitude }
#                         1 = { set_country_flag = mem_shroud_cult_sermon_of_knowledge }
#                         1 = { set_country_flag = mem_shroud_cult_sermon_of_labour }
#                         1 = { set_country_flag = mem_shroud_cult_sermon_of_ingenuity }
#                         1 = { set_country_flag = mem_shroud_cult_sermon_of_prosperity }
#                     }
#                     event_target:mem_shroud_cult_country = {
#                         add_trust = {
#                             who = root
#                             amount = 20
#                         }
#                     }

#                     modifier = {
#                         factor = 0
#                         has_country_flag = mem_shroud_cult_bought_a_sermon   
#                     }

#                     modifier = {
#                         factor = 0
#                         event_target:mem_shroud_cult_country = {
#                             trust = {
#                                 who = root
#                                 value < 100
#                             }
#                         }
#                     }
#                     log = "[Root.GetName] bought Sermon"
#                 }
#                 4 = { log = "[Root.GetName] bought nothing" }
#             }
#         }
#         else_if = {
#             limit = {
#                 resource_stockpile_compare = {
#                     resource = energy
#                     value > 3000
#                 }
#             }
#             random_list = {
#                 1 = { log = "[Root.GetName] didn't buy Mercy Coprs" }
#                 1 = {
#                     add_modifier = {
#                         modifier = mem_shroud_cult_mercy_corps
#                         days = @mercy_modifier_length
#                     }
#                     change_variable = {
#                         which = mem_shroud_cult_subversion_mana
#                         value = @mercy_subversion_mana
#                     }
#                     set_country_flag = mem_shroud_cult_hired_corps
#                     event_target:mem_shroud_cult_country = {
#                         add_trust = {
#                             who = root
#                             amount = 20
#                         }
#                     }
#                     add_resource = {
#                         energy = -1000
#                     }
#                     log = "[Root.GetName] bought Mercy Corps"
#                 }
#             }
#         }
#     }
# }