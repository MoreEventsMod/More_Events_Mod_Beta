# Shielded Precursors
# By ViolentBeetle

namespace = mem_shieldcursors

# Game start event. Checking clusters, deciding on shieldcursor type
event = {
	id = mem_shieldcursors.1
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		any_system = {
			has_star_flag = mem_shieldcustor_system
		}
	}

	immediate = {
		random_list = {
			1 = { set_global_flag = mem_shieldcursor_brain_drain }
			# 1 = { set_global_flag = mem_shieldcursor_morgolg }
			# 1 = { set_global_flag = mem_shieldcursor_xaal }
		}
		random_system = {
			limit = {
				has_star_flag = mem_shieldcustor_system
			}
			every_system = {
				limit = {
					distance = {
						source = prev
						use_bypasses = no
						min_jumps = 1
						max_jumps = 2
					}
				}
				set_star_flag = mem_shieldcursor_cluster
				set_star_flag = mem_shieldcursor_cluster_t1
			}
			every_system = {
				limit = {
					distance = {
						source = prev
						use_bypasses = no
						min_jumps = 3
						max_jumps = 4
					}
				}
				set_star_flag = mem_shieldcursor_cluster
				set_star_flag = mem_shieldcursor_cluster_t2
			}
		}
	}
}

# Surveying shielded world
ship_event = {
	id = mem_shieldcursors.2
	title = mem_shieldcursors.2.name
	desc = mem_shieldcursors.2.desc

	is_triggered_only = yes

	show_sound = event_default
	location = FROM
	picture = GFX_evt_shielded_planet

	trigger = {
		FROM = {
			has_planet_flag = mem_shieldcursor_planet
			is_planet_class = pc_shielded
		}
		owner = {
			NOT = {
				has_country_flag = mem_shieldcursors_completed_last_dig
			}
		}
	}

	option = {
		name = INTERESTING
	}
}

#########################
# BRAIN DRAIN STORYLINE #
#########################

ship_event = {
	id = mem_shieldcursors.100
	title = mem_shieldcursors.100.name
	desc = mem_shieldcursors.100.desc

	is_triggered_only = yes

	location = FROM
	show_sound = event_default
	picture = GFX_evt_mem_spaceship_wreck

	trigger = {
		NOT = { has_global_flag = mem_shieldcursors_dig_site_tripped }
		has_global_flag = mem_shieldcursor_brain_drain
		FROM = {
			solar_system = {
				has_star_flag = mem_shieldcursor_cluster
			}
			OR = {
				is_planet_class = pc_barren
				is_planet_class = pc_barren_cold
				is_planet_class = pc_toxic
				is_planet_class = pc_gas_giant
				is_planet_class = pc_frozen
				is_planet_class = pc_molten
			}
			is_moon = no
			has_anomaly = no
			NOT = { exists = archaeological_site }
		}
	}

	immediate = {
		set_global_flag = mem_shieldcursors_dig_site_tripped
	}

	option = {
		name = mem_shieldcursors.100.a

		FROM = {
			create_archaeological_site = mem_shieldcursors_brain_drain_site_1
		}

		ai_chance = {
			factor = 100
		}
	}

	option = {
		name = mem_shieldcursors.100.b
		custom_tooltip = mem_shieldcursors.100.b.tooltip

		trigger = {
			owner = { is_ai = no }
		}
	}
}

# Dig site event 1
fleet_event = {
	id = mem_shieldcursors.101
	title = mem_shieldcursors.101.name
	desc = mem_shieldcursors.101.desc

	archaeology = yes
	is_triggered_only = yes

	picture = GFX_evt_derelict_interior
	show_sound = event_finding_loot

	immediate = {
		from = { set_site_progress_locked = yes }
	}
    
	after = { 
		from = { set_site_progress_locked = no } 
	}

	option = {
		name = DIG
		small_artifact_reward = yes
	}
}

# Dig site event 2
fleet_event = {
	id = mem_shieldcursors.102
	title = mem_shieldcursors.102.name
	desc = mem_shieldcursors.102.desc

	archaeology = yes
	is_triggered_only = yes

	picture = GFX_evt_mem_horror_corridor
	show_sound = event_finding_loot

	immediate = {
		from = { set_site_progress_locked = yes }
	}
    
	after = { 
		from = { set_site_progress_locked = no } 
	}

	option = {
		name = DIG
		small_artifact_reward = yes
	}
}

# Dig site event 3
fleet_event = {
	id = mem_shieldcursors.103
	title = mem_shieldcursors.103.name
	desc = mem_shieldcursors.103.desc

	archaeology = yes
	is_triggered_only = yes

	picture = GFX_evt_ancient_databank
	show_sound = event_finding_loot

	immediate = {
		from = { set_site_progress_locked = yes }
	}
    
	after = { 
		from = { set_site_progress_locked = no } 
	}

	option = {
		name = DIG
		small_artifact_reward = yes
	}
}

# Dig site event 4
fleet_event = {
	id = mem_shieldcursors.104
	title = mem_shieldcursors.104.name
	desc = mem_shieldcursors.104.desc

	archaeology = yes
	is_triggered_only = yes

	picture = GFX_evt_ship_in_orbit_2
	show_sound = event_finding_loot

	immediate = {
		from = { set_site_progress_locked = yes }
		random_planet = {
			limit = {
				OR = {
					is_planet_class = pc_barren_cold
					is_planet_class = pc_barren
				}
				solar_system = {
					has_star_flag = mem_shieldcursor_cluster
					NOT = { is_same_value = from.planet.solar_system }
				}
				has_anomaly = no
				NOT = { exists = archaeological_site }
			}
			weights = {
				base = 1
				modifier = {
					mult = 100
					solar_system = {
						has_star_flag = mem_shieldcursor_cluster_t2
					}
				}
				modifier = {
					mult = 5
					solar_system = {
						exists = space_owner
						space_owner = { is_same_value = root.owner }
					}
				}
			}
			save_event_target_as = next_target
		}
	}
    
	after = { 
		from = { set_site_progress_locked = no } 
	}

	option = {
		name = mem_shieldcursors.104.a
		from.planet = {
			save_event_target_as = ship_planet
		}
		owner = {
			set_country_flag = mem_shieldcursors_investigator
		}
		IF = {
			limit = {
				exists = event_target:next_target
			}
			enable_special_project = {
				name = MEM_SHIELDCURSORS_BRAIN_DRAIN_COLONY
				location = event_target:next_target
				owner = root.owner
			}
		}
	}
}

# Finish first project
ship_event = {
	id = mem_shieldcursors.110
	title = mem_shieldcursors.110.name
	desc = mem_shieldcursors.110.desc

	is_triggered_only = yes

	location = event_target:next_target
	picture = GFX_evt_mining_operations
	show_sound = event_default

	option = {
		name = INTERESTING
		event_target:next_target = {
			create_archaeological_site = mem_shieldcursors_brain_drain_site_2
		}
	}
}

# Second dig site. Stage 1
fleet_event = {
	id = mem_shieldcursors.111
	title = mem_shieldcursors.111.name
	desc = mem_shieldcursors.111.desc

	archaeology = yes
	is_triggered_only = yes

	picture = GFX_evt_tradestation_interior
	show_sound = event_finding_loot

	immediate = {
		from = { set_site_progress_locked = yes }
	}
    
	after = { 
		from = { set_site_progress_locked = no } 
	}

	option = {
		name = DIG
		small_artifact_reward = yes
	}
}

# Second dig site. Stage 2
fleet_event = {
	id = mem_shieldcursors.112
	title = mem_shieldcursors.112.name
	desc = mem_shieldcursors.112.desc

	archaeology = yes
	is_triggered_only = yes

	picture = GFX_evt_hive_mind
	show_sound = event_finding_loot

	immediate = {
		from = { set_site_progress_locked = yes }
	}
    
	after = { 
		from = { set_site_progress_locked = no } 
	}

	option = {
		name = DIG
		small_artifact_reward = yes
	}
}

# Second dig site. Stage 3
fleet_event = {
	id = mem_shieldcursors.113
	title = mem_shieldcursors.113.name
	desc = mem_shieldcursors.113.desc

	archaeology = yes
	is_triggered_only = yes

	picture = GFX_evt_star_chart
	show_sound = event_finding_loot

	immediate = {
		from = { set_site_progress_locked = yes }

		random_planet = {
			limit = {
				OR = {
					is_planet_class = pc_barren_cold
					is_planet_class = pc_barren
				}
				solar_system = {
					has_star_flag = mem_shieldcursor_cluster
					NOT = { is_same_value = from.planet.solar_system }
				}
				has_anomaly = no
				NOT = { exists = archaeological_site }
			}
			weights = {
				base = 1
				modifier = {
					mult = 100
					solar_system = {
						has_star_flag = mem_shieldcursor_cluster_t1
					}
				}
				modifier = {
					mult = 5
					solar_system = {
						exists = space_owner
						space_owner = { is_same_value = root.owner }
					}
				}
			}
			save_event_target_as = girb_homeworld
		}
	}
    
	after = { 
		from = { set_site_progress_locked = no } 
	}

	option = {
		name = mem_shieldcursors.113.a
		IF = {
			limit = {
				exists = event_target:girb_homeworld
			}
			enable_special_project = {
				name = MEM_SHIELDCURSORS_GIRB_HOMEWORLD
				location = event_target:girb_homeworld
				owner = root.owner
			}
		}
	}
}

# Finish first project
ship_event = {
	id = mem_shieldcursors.120
	title = mem_shieldcursors.120.name
	desc = mem_shieldcursors.120.desc

	is_triggered_only = yes

	location = event_target:next_target
	picture = GFX_evt_mining_operations
	show_sound = event_default

	option = {
		name = INTERESTING
		event_target:girb_homeworld = {
			create_archaeological_site = mem_shieldcursors_brain_drain_site_3
		}
	}
}

# Third dig site. Stage 1
fleet_event = {
	id = mem_shieldcursors.121
	title = mem_shieldcursors.121.name
	desc = mem_shieldcursors.121.desc

	archaeology = yes
	is_triggered_only = yes

	picture = GFX_evt_tradestation_interior
	show_sound = event_finding_loot

	immediate = {
		from = { set_site_progress_locked = yes }
	}
    
	after = { 
		from = { set_site_progress_locked = no } 
	}

	option = {
		name = DIG
		small_artifact_reward = yes
	}
}

# Second dig site. Stage 2
fleet_event = {
	id = mem_shieldcursors.122
	title = mem_shieldcursors.122.name
	desc = mem_shieldcursors.122.desc

	archaeology = yes
	is_triggered_only = yes

	picture = GFX_evt_hive_mind
	show_sound = event_finding_loot

	immediate = {
		from = { set_site_progress_locked = yes }
	}
    
	after = { 
		from = { set_site_progress_locked = no } 
	}

	option = {
		name = DIG
		small_artifact_reward = yes
	}
}

# Second dig site. Stage 3
fleet_event = {
	id = mem_shieldcursors.123
	title = mem_shieldcursors.123.name
	desc = mem_shieldcursors.123.desc

	archaeology = yes
	is_triggered_only = yes

	picture = GFX_evt_star_chart
	show_sound = event_finding_loot

	immediate = {
		from = { set_site_progress_locked = yes }

		random_planet = {
			limit = {
				has_planet_flag = mem_shieldcursor_planet
			}
			save_event_target_as = shielded_planet
		}
	}
    
	after = { 
		from = { set_site_progress_locked = no } 
		owner = { set_country_flag = mem_shieldcursors_completed_last_dig }
	}

	option = {
		name = mem_shiedcursors.123.a
		enable_special_project = {
			name = MEM_SHIELDCURSORS_DROP_SHIELD
			location = event_target:shielded_planet
			owner = root.owner
		}
	}
}

#Droping the shield for Brain Drain
ship_event = {
	id = mem_shieldcursors.130
	title = mem_shieldcursors.130.name
	desc = mem_shieldcursors.130.desc

	is_triggered_only = yes

	show_sound = event_default
	picture = GFX_evt_shielded_planet
	location = event_target:shielded_planet

	option = {
		name = mem_shieldcursors.130.a
		event_target:shielded_planet = {
			change_pc = pc_relic
			hidden_effect = {
				relic_world_deposits = yes
			}
			create_archaeological_site = mem_shieldcursors_brain_drain_site_4
		}
	}
}

# Fourth dig site. Stage 1
fleet_event = {
	id = mem_shieldcursors.131
	title = mem_shieldcursors.131.name
	desc = mem_shieldcursors.131.desc

	archaeology = yes
	is_triggered_only = yes

	picture = GFX_evt_tradestation_interior
	show_sound = event_finding_loot

	immediate = {
		from = { set_site_progress_locked = yes }
	}
    
	after = { 
		from = { set_site_progress_locked = no } 
	}

	option = {
		name = DIG
		small_artifact_reward = yes
	}
}

# Fourth dig site. Stage 2
fleet_event = {
	id = mem_shieldcursors.132
	title = mem_shieldcursors.132.name
	desc = mem_shieldcursors.132.desc

	archaeology = yes
	is_triggered_only = yes

	picture = GFX_evt_hive_mind
	show_sound = event_finding_loot

	immediate = {
		from = { set_site_progress_locked = yes }
	}
    
	after = { 
		from = { set_site_progress_locked = no } 
	}

	option = {
		name = mem_shieldcursors.132.a
		custom_tooltip = mem_shieldcursors.132.a.tooltip
		hidden_effect = {
			create_ship_design = {
				design = NAME_MEM_Shieldcursors_Brain_Drain_Reward
			}
			create_fleet = {
				name = "Ancient Ship"
				effect = {
					set_owner = root.owner
					create_ship = {
						name = NAME_MEM_Shieldcursors_Brain_Drain_Reward
						design = last_created_design
						effect = {
							add_modifier = {
								modifier = mem_shieldcursor_delayed_gratification
								days = 900
							}
							add_modifier = {
								modifier = mem_shieldcursor_delayed_gratification
								days = 1800
							}
							add_modifier = {
								modifier = mem_shieldcursor_delayed_gratification
								days = 2700
							}
							add_modifier = {
								modifier = mem_shieldcursor_delayed_gratification
								days = 3600
							}
							reduce_hp_percent = 0.75
						}
					}
					set_location = from.planet
				}
			}
		}
	}
	option = {
		name = mem_shieldcursors.132.b
		owner = {
			add_resource = {
				alloys = 500
				rare_crystals = 100
				volatile_motes = 100
				exotic_gases = 100
				influence = 100
			}
			IF = {
				limit = {
					NOT = { has_technology = tech_destroyers }
				}
				give_technology = {
					tech = tech_destroyers
				}
			}
			ELSE_IF = {
				limit = {
					NOT = { has_technology = tech_cruisers }
				}
				give_technology = {
					tech = tech_cruisers
				}
			}
			ELSE_IF = {
				limit = {
					NOT = { has_technology = tech_battleships }
				}
				give_technology = {
					tech = tech_battleships
				}
			}
			ELSE = {
				add_monthly_resource_mult = {
					resource = engineering_research
					value = @tier5researchreward
					min = @tier5researchmin
					max = @tier5researchmax
				}
			}
		}
	}
}