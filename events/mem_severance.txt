# Severance
# By ViolentBeetle

namespace = mem_severance

@days_to_start = 100
@loop_length = 30
@time_to_sudden_death = 200

# Intro event - why no FTL
fleet_event = {
    id = mem_severance.1
    title = mem_severance.1.name
    desc = mem_severance.1.desc

    picture = GFX_evt_busy_spaceport
    show_sound = event_finding_loot

    archaeology = yes
    is_triggered_only = yes
    
    immediate = {
		from = { set_site_progress_locked = yes }
	}

	after = { 
		from = { set_site_progress_locked = no } 
    }
    
    option = {
		name = DIG
		owner = { 
			add_monthly_resource_mult = {
     			resource = engineering_research
     			value = @tier3researchreward
     			min = @tier3researchmin
     			max = @tier3researchmax
     		}
 		}
        IF = {
            limit = {
                from.planet = { is_planet_class = pc_relic }
            }
            from.planet = { remove_deposit = d_mem_severance_dense_ruins }
        }
	}
}

# Congress, first mentions of Severance
fleet_event = {
    id = mem_severance.2
    title = mem_severance.2.name
    desc = mem_severance.2.desc

    picture = GFX_evt_federation_fleet
    show_sound = event_finding_loot

    archaeology = yes
    is_triggered_only = yes

    immediate = {
		from = { set_site_progress_locked = yes }
	}

	after = { 
		from = { set_site_progress_locked = no } 
    }

    option = {
        name = DIG
        owner = { 
			add_monthly_resource_mult = {
     			resource = society_research
     			value = @tier4researchreward
     			min = @tier4researchmin
     			max = @tier4researchmax
     		}
 		}
        IF = {
            limit = {
                from.planet = { is_planet_class = pc_relic }
            }
            from.planet = { remove_deposit = d_mem_severance_dense_ruins }
        }
    }
}

# Layers Deep
fleet_event = {
    id = mem_severance.3
    title = mem_severance.3.name
    desc = mem_severance.3.desc

    picture = GFX_evt_habitable_dig_site
    show_sound = event_finding_loot

    archaeology = yes
    is_triggered_only = yes

    immediate = {
		from = { set_site_progress_locked = yes }
	}

	after = { 
		from = { set_site_progress_locked = no } 
    }

    option = {
        name = DIG
        IF = {
            limit = {
                from.planet = { is_planet_class = pc_relic }
            }
            from.planet = { 
                add_deposit = d_mem_severance_decrepit_dig_site
                remove_deposit = d_mem_severance_dense_ruins
            }
        }
        ELSE = {
            owner = {
                add_monthly_resource_mult = {
                    resource = unity
                    value = @tier3unityreward
                    min = @tier3unitymin
                    max = @tier3unitymax
                }
            }
        }
    }
}

# The Red Zone
fleet_event = {
    id = mem_severance.4
    title = mem_severance.4.name
    desc = mem_severance.4.desc

    picture = GFX_evt_mem_factory_02
    show_sound = event_finding_loot

    archaeology = yes
    is_triggered_only = yes

    immediate = {
		from = { set_site_progress_locked = yes }
	}

	after = { 
		from = { set_site_progress_locked = no } 
    }

    option = {
        name = DIG
        IF = {
            limit = {
                from.planet = { is_planet_class = pc_relic }
            }
            from.planet = { 
                add_deposit = d_mem_severance_ruined_red_zone
                remove_deposit = d_mem_severance_dense_ruins
            }
        }
        ELSE = {
            owner = {
                add_resource = {
                    volatile_motes = 50
                    exotic_gases = 50
                }
            }
        }
    }
}

# The Constitution Hall
fleet_event = {
    id = mem_severance.5
    title = mem_severance.5.name
    desc = mem_severance.5.desc

    picture = GFX_evt_relic_world_building
    show_sound = event_celebration

    archaeology = yes
    is_triggered_only = yes

    immediate = {
		from = { set_site_progress_locked = yes }
	}

	after = { 
		from = { set_site_progress_locked = no } 
    }

    option = {
        name = DIG
        IF = {
            limit = {
                from.planet = { is_planet_class = pc_relic }
            }
            from.planet = {
                add_deposit = d_mem_severance_ruined_constitution_hall
                remove_deposit = d_mem_severance_dense_ruins
            }
        }
        ELSE = {
            owner = {
                add_resource = {
                    rare_crystals = 100
                }
            }
        }
    }
}

# The End
fleet_event = {
    id = mem_severance.6
    title = mem_severance.6.name
    desc = mem_severance.6.desc

    picture = GFX_evt_mem_terror_attack
    show_sound = event_screams

    archaeology = yes
    is_triggered_only = yes

    immediate = {
		from = { set_site_progress_locked = yes }
	}

	after = { 
		from = { set_site_progress_locked = no } 
    }

    option = {
        name = mem_severance.6.a
        IF = {
            limit = {
                from.planet = { is_planet_class = pc_relic }
            }
            custom_tooltip = mem_severance.6.a.tooltip
            from.planet = {
                set_planet_flag = mem_severance_feature_unlock
                remove_deposit = d_mem_severance_dense_ruins
            }
        }
        ELSE = {
            owner = {
                add_monthly_resource_mult = {
                    resource = society_research
                    value = @tier4researchreward
                    min = @tier4researchmin
                    max = @tier4researchmax
                }
                add_monthly_resource_mult = {
                    resource = engineering_research
                    value = @tier4researchreward
                    min = @tier4researchmin
                    max = @tier4researchmax
                }
                add_monthly_resource_mult = {
                    resource = physics_research
                    value = @tier4researchreward
                    min = @tier4researchmin
                    max = @tier4researchmax
                }
            }
        }
        from.planet = {
            add_modifier = {
                modifier = mem_severance_uncertain_times
                days = -1
            }
            hidden_effect = {
                set_timed_planet_flag = {
                    flag = mem_severance_time_to_sudden_death
                    days = @time_to_sudden_death
                }
                planet_event = {
                    id = mem_severance.7
                    days = @days_to_start
                }
            }
        }
    }
}

# The loop for the final encounter
planet_event = {
    id = mem_severance.7
    hide_window = yes
    is_triggered_only = yes

    immediate = {
        random_list = {
            95 = {
                planet_event = { id = mem_severance.7 days = @loop_length }
                modifier = {
                    factor = 0.1
                    NOT = { has_planet_flag = mem_severance_time_to_sudden_death }
                }
            }
            5 = {
                planet_event = { id = mem_severance.20 }
                modifier = {
                    factor = 0
                    NOT = { exists = owner }
                }
                modifier = {
                    factor = 0
                    num_pops < 5
                }
                modifier = {
                    factor = 2
                    num_pops > 10
                }
                modifier = {
                    factor = 3
                    num_pops > 40
                }
                modifier = {
                    factor = 4
                    num_pops > 80
                }
            }
        }
    }
}

# Game start event: Isolate wormhole system, since it doesn't seem to be islateable from initializer
event = {
    id = mem_severance.10
    hide_window = yes
    is_triggered_only = yes

    immediate = {
        random_system = {
            limit = {
                has_star_flag = mem_severance_relic_system
            }
            isolate_system = yes
        }
    }
}

# Harvesters arrive
planet_event = {
    id = mem_severance.20
    title = mem_severance.20.name
    desc = mem_servance.20.desc

    is_triggered_only = yes
    picture = GFX_evt_mem_rift
    location = ROOT
    show_sound = event_red_alert

    immediate = {
        # Harvester spawnage goes here
    }

    option = {
        name = ONSCREEN
        hidden_effect = {
            owner = {
                country_event = { id = mem_severance.21 }
            }
        }
    }
}

# Diplomatic event
country_event = {
    id = mem_severance.21
    title = TRANSMISSION
    desc = {
        text = mem_severance.21.desc
        trigger = {
            is_gestalt = no
        }
    }
    desc = {
        text = mem_severance.21.desc.hive
        trigger = {
            is_hive_empire = yes
        }
    }
    desc = {
        text = mem_severance.21.desc.machine
        trigger = {
            is_machine_empire = yes
        }
    }

    is_triggered_only = yes
    diplomatic = yes

    picture_event_data = {
        room = no_video_feed_room
    }

    option = {
        name = mem_severance.21.a
    }

    option = {
        name = mem_severance.21.b
        response_text = mem_severance.21.b.reply
        is_dialog_only = yes
    }
    option = {
        name = mem_severance.21.c
        response_text = mem_severance.21.c.reply
        is_dialog_only = yes
    }
}