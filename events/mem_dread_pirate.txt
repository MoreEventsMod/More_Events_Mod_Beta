# Dread Pirate's Mask
# By ViolentBeetle

namespace = mem_dread_pirate

# Raiding ship destruction incident - on_ship_destroyed_victim
country_event = {
    id = mem_dread_pirate.1
    hide_window = yes
    is_triggered_only = yes

    trigger = {
        log = "[Root.GetName] evaluates a trigger. [fromfromfrom.solar_system.GetName] system."
        # mid_game_years_passed < 25
        is_country_type = marauder_raiders
        from = {
            is_ai = no
            NOT = { has_country_flag = mem_dread_pirate_offered_quest }
        }
        any_country = {
            is_country_type = dormant_marauders
            has_country_flag = parent_of@root
            from = {
                has_country_flag = raid_target_of@prev
            }
        }    
    }

    immediate = {
        log = "Dread Pirate Intro Rolled"
        random_list = {
            # 200 = {  }
            3 = {
                log = "Roll Passed"
                fromfromfrom.solar_system = { save_event_target_as = combat_system }
                random_country = {
                    limit = {
                        is_country_type = dormant_marauders
                        has_country_flag = parent_of@root
                        from = {
                            has_country_flag = raid_target_of@prev
                        }
                    }
                    save_event_target_as = marauder_sender
                }
                from = {
                    country_event = {
                        id = mem_dread_pirate.2 days = 30
                    }
                }
            }
        }
    }
}

# Dread pirate intro
country_event = {
    id = mem_dread_pirate.2
    title = mem_dread_pirate.2.name
    desc = mem_dread_pirate.2.desc

    is_triggered_only = yes
    location = event_target:the_planet

    show_sound = event_sensor_ping
    picture = GFX_evt_mem_heavy_damage

    trigger = {
        NOT = { has_country_flag = mem_dread_pirate_offered_quest }
        NOT = { has_global_flag = mem_dread_pirate_global_lock }
        exists = event_target:marauder_sender
        event_target:marauder_sender = {
            is_country_type = dormant_marauders
        }                    
        any_planet_within_border = {
            OR = {
                is_planet_class = pc_barren
                is_planet_class = pc_barren_cold
            }
            NOT = { exists = archaeological_site }
            has_anomaly = no
            solar_system = {
                NOT = { is_same_value = root.capital_scope.solar_system }
                NOT = { is_same_value = event_target:combat_system }
            }
        }
    }

    immediate = {
        set_country_flag = mem_dread_pirate_offered_quest
        set_global_flag = mem_dread_pirate_global_lock
        random_planet_within_border = {
            limit = {
                OR = {
                    is_planet_class = pc_barren
                    is_planet_class = pc_barren_cold
                }
                NOT = { exists = archaeological_site }
                has_anomaly = no
                solar_system = {
                    NOT = { is_same_value = root.capital_scope.solar_system }
                    NOT = { is_same_value = event_target:combat_system }
                }
            }
            save_event_target_as = the_planet
        }
    }

    option = {
        name = mem_dread_pirate.2.a
        set_country_flag = mem_dread_pirate_has_quest
        event_target:the_planet = {
            enable_special_project = {
                name = MEM_DREAD_PIRATE_PROJECT
                location = this
                owner = root
            }
        }
    }

    option = {
        name = NOTIME
        remove_global_flag = mem_dread_pirate_global_lock
        add_resource = {
            influence = 250
        }
    }
}

# Special project complete, issuing a dig site
ship_event = {
    id = mem_dread_pirate.3
    title = mem_dread_pirate.3.name
    desc = mem_dread_pirate.3.desc

    is_triggered_only = yes
    
    show_sound = event_sensor_ping
    location = event_target:the_planet
    picture = GFX_evt_mining_operations

    option = {
        name = mem_dread_pirate.3.a
        event_target:the_planet = {
            create_archaeological_site = mem_dread_pirate_dig_site
        }
    }
}

### DIG SITES ###
fleet_event = {
    id = mem_dread_pirate.11
    title = mem_dread_pirate.11.name
    desc = mem_dread_pirate.11.desc

    is_triggered_only = yes
    archaeology = yes

    picture = GFX_evt_underground_city
    show_sound = event_finding_loot

    immediate = {
		from = { set_site_progress_locked = yes }
	}

	after = { 
		from = { set_site_progress_locked = no } 
    }

    option = {
        name = DIG
        small_artifact_reward = yes
    }
}
fleet_event = {
    id = mem_dread_pirate.12
    title = mem_dread_pirate.12.name
    desc = mem_dread_pirate.12.desc

    is_triggered_only = yes
    archaeology = yes

    picture = GFX_evt_smugglers_in_bar
    show_sound = event_finding_loot

    immediate = {
		from = { set_site_progress_locked = yes }
	}

	after = { 
		from = { set_site_progress_locked = no } 
    }

    option = {
        name = DIG
        small_artifact_reward = yes
    }
}
fleet_event = {
    id = mem_dread_pirate.13
    title = mem_dread_pirate.13.name
    desc = mem_dread_pirate.13.desc

    is_triggered_only = yes
    archaeology = yes

    picture = GFX_evt_derelict_interior
    show_sound = event_finding_loot

    immediate = {
		from = { set_site_progress_locked = yes }
	}

	after = { 
		from = { set_site_progress_locked = no } 
    }

    option = {
        name = DIG
        medium_artifact_reward = yes
    }
}
fleet_event = {
    id = mem_dread_pirate.14
    title = mem_dread_pirate.14.name
    desc = mem_dread_pirate.14.desc

    is_triggered_only = yes
    archaeology = yes

    picture = GFX_evt_archaeologists_escaping
    show_sound = event_finding_loot

    immediate = {
		from = { set_site_progress_locked = yes }
	}

	after = { 
		from = { set_site_progress_locked = no } 
    }

    option = {
        name = DIG
        medium_artifact_reward = yes
    }
}
fleet_event = {
    id = mem_dread_pirate.15
    title = mem_dread_pirate.15.name
    desc = mem_dread_pirate.15.desc

    is_triggered_only = yes
    archaeology = yes

    picture = GFX_evt_mem_horror_corridor
    show_sound = event_finding_loot

    immediate = {
		from = { set_site_progress_locked = yes }
	}

	after = { 
		from = { set_site_progress_locked = no } 
    }

    option = {
        name = DIG
        medium_artifact_reward = yes
    }
}
fleet_event = {
    id = mem_dread_pirate.16
    title = mem_dread_pirate.16.name
    desc = mem_dread_pirate.16.desc

    is_triggered_only = yes
    archaeology = yes

    picture = GFX_evt_in_the_dark
    show_sound = event_finding_loot

    immediate = {
		from = { set_site_progress_locked = yes }
	}

	after = { 
		from = { set_site_progress_locked = no } 
    }

    option = {
        name = mem_dread_pirate.16.a
        large_artifact_reward = yes
        owner = { set_country_flag = mem_dread_pirate_finished_the_dig }
        hidden_effect = {
            create_country = {
                name = "Dread Pirate Fleet"
                type = mem_dread_pirate_country
                flag = {
                    icon = {
                        category = pirate
                        file = flag_pirate_9.dds
                    }
                    background = {
                        category = background
                        file = triangle_split.dds
                    }
                    colors = {
                        "red"
                        "black"
                        "null"
                        "null"
                    }
                }
                name_list = PRT1
                effect = {
                    set_graphical_culture = pirate_01
                    save_event_target_as = dread_pirate_country
                    every_country = {
                        limit = {
                            is_country_type = dormant_marauders
                        }
                        set_faction_hostility = {
                            target = prev
                            set_hostile = no
                        }
                    }
                    country_event = { id = mem_dread_pirate.20 days = 10 }
                }
            }
        }
    }
}

# Dread Pirate fleet's spawning
country_event = {
    id = mem_dread_pirate.20
    hide_window = yes
    is_triggered_only = yes

    trigger = {
        NOT = { has_global_flag = mem_dread_pirate_first_encounter }
        any_country = {
            is_country_type = dormant_marauders
        }
    }

    immediate = {
        random_country = {
            limit = { is_country_type = dormant_marauders }
            event_target:dread_pirate_country = {
                create_leader = {
                    name = Raewynn
                    class = admiral
                    skill = 10
                    species = prev.species
                    effect = {
                        set_leader_flag = mem_dread_pirate_first_leader
                    }
                }
            }
            random_system_within_border = {
                create_fleet = {
                    name = "Dread Pirate's Forces"
                    effect = {
                        set_owner = event_target:dread_pirate_country
                        while = {
                            count = 3
                            create_ship = {
                                design = NAME_Black_Earl
                            }
                        }
                        while = {
                            count = 5
                            create_ship = {
                                design = NAME_Marauder
                            }
                        }
                        while = {
                            count = 5
                            create_ship = {
                                design = NAME_Corsair
                            }
                        }
                        while = {
                            count = 8
                            create_ship = {
                                design = NAME_Reaver
                            }
                        }
                        while = {
                            count = 8
                            create_ship = {
                                design = NAME_Brigand
                            }
                        }
                        create_ship_design = {
                            design = NAME_MEM_Dread_Pirate_Galleon
                        }
                        create_ship = {
                            name = "Dread Lord"
                            design = last_created_design
                            effect = {
                                set_ship_flag = mem_dread_pirate_first_flagship
                            }
                        }
                        save_event_target_as = dread_fleet
                        set_location = prev
                        set_leader = last_created_leader
                        set_fleet_flag = mem_dread_pirate_the_first_fleet
                    }
                }
                closest_system = {
                    limit = {
                        exists = owner
                        owner = { has_country_flag = mem_dread_pirate_finished_the_dig }
                    }
                    event_target:dread_fleet = {
                        auto_move_to_planet = {
                            target = prev.star
                            clear_auto_move_on_arrival = yes                            
                        }
                    }
                    log = "Set Dread Pirate to [This.GetName]"
                }
            }
        }
        country_event = { id = mem_dread_pirate.21 days = 10 }
    }
}

# Safety checks in case path breaks
country_event = {
    id = mem_dread_pirate.21
    hide_window = yes
    is_triggered_only = yes

    trigger = {
        NOT = { has_global_flag = mem_dread_pirate_first_encounter }
    }

    immediate = {
        log = ".21 loop engaged"
        IF = {
            limit = {
                NOT = {
                    any_owned_fleet = {
                        has_fleet_flag = mem_dread_pirate_the_first_fleet
                    }
                }
            }
            log = "Fleet not found"
            country_event = { id = mem_dread_pirate.20 days = 20 }
        }
        ELSE = {
            log = "Fleet found"
            random_owned_fleet = {
                limit = { has_fleet_flag = mem_dread_pirate_the_first_fleet }
                IF = {
                    limit = {
                        NAND = {
                            any_owned_ship = { has_ship_flag = mem_dread_pirate_first_flagship }
                            exists = leader
                        }
                        is_in_combat = no
                    }
                    log = "Galleon or leader not found"
                    delete_fleet = this
                }
                ELSE_IF = {
                    limit = {
                        is_fleet_idle = yes
                        is_in_combat = no
                    }
                    log = "Fleet stuck"
                    clear_fleet_actions = this
                    closest_system = {
                        limit = {
                            exists = owner
                            owner = { has_country_flag = mem_dread_pirate_finished_the_dig }
                        }
                        prev = {
                            auto_move_to_planet = {
                                target = prev.star
                                clear_auto_move_on_arrival = yes                            
                            }
                        }
                        log = "Set Dread Pirate to [This.GetName]"
                    }
                }
            }
            country_event = { id = mem_dread_pirate.21 days = 10 }
        }
    }
}

# Dread Pirate delegation hits the system for the first time, galleon must be present
ship_event = {
    id = mem_dread_pirate.22
    hide_window = yes
    is_triggered_only = yes

    trigger = {
        NOT = { has_global_flag = mem_dread_pirate_first_encounter }
        owner = { is_country_type = mem_dread_pirate_country }
        has_ship_flag = mem_dread_pirate_first_flagship
        exists = leader
        from = {
            exists = owner
            owner = { has_country_flag = mem_dread_pirate_finished_the_dig }
        }
    }

    immediate = {
        fleet = { clear_fleet_actions = this }
        owner = { save_event_target_as = dread_pirate_country }
        leader = { save_event_target_as = convo_portrait }
        set_global_flag = mem_dread_pirate_first_encounter
        from.owner = {
            country_event = { id = mem_dread_pirate.23 }
        }
    }
}

# Dread pirate have entered our system
country_event = {
    id = mem_dread_pirate.23
    title = mem_dread_pirate.23.name
    desc = mem_dread_pirate.23.desc

    is_triggered_only = yes

    location = from
    show_sound = event_yellow_alert
    picture = GFX_evt_pirate_armada

    option = {
        name = ONSCREEN
        hidden_effect = {
            establish_communications_no_message = event_target:dread_pirate_country
            country_event = { id = mem_dread_pirate.24 }
        }
    }
}

# Dread pirate convo
country_event = {
    id = mem_dread_pirate.23
    title = TRANSMISSION
    desc = mem_dread_pirate.23.desc

    is_triggered_only = yes
    diplomatic = yes

    picture_event_data = {
        portrait = event_target:convo_portrait
		room = "ethic_spaceship_room"
    }

    option = {
        name = mem_dread_pirate.23.a
        response_text = mem_dread_pirate.23.a.response
        hidden_effect = {
            event_target:dread_pirate_country = {
                set_faction_hostility = {
                    target = root
                    set_hostile = yes
                }
            }
        }
    }
    option = {
        name = mem_dread_pirate.23.b
        response_text = mem_dread_pirate.23.b.response
        hidden_effect = {
            event_target:dread_pirate_country = {
                set_faction_hostility = {
                    target = root
                    set_hostile = yes
                }
            }
        }
    }
    option = {
        name = mem_dread_pirate.23.c
        response_text = mem_dread_pirate.23.c.response
        is_dialog_only = yes
    }
    option = {
        name = mem_dread_pirate.23.d
        response_text = mem_dread_pirate.23.d.response
        is_dialog_only = yes
    }
}

# Trigger on shooting down the galleon
country_event = {
    id = mem_dread_pirate.24
    hide_window = yes
    is_triggered_only = yes

    trigger = {
        is_country_type = mem_dread_pirate_country
        fromfrom = { has_ship_flag = mem_dread_pirate_first_flagship }
    }

    immediate = {
        log = "Galleon dead"
        IF = {
            limit = {
                has_global_flag = mem_dread_pirate_first_encounter
            }
            create_ambient_object = {
                type = pirate_01_galleon_destroyed_entity
                location = fromfrom
            }
            last_created_ambient_object = {
                save_event_target_as = dead_galleon
            }
            from = { save_event_target_as = ship_killer }
            random_country = {
                limit = { has_country_flag = mem_dread_pirate_finished_the_dig }
                country_event = { id = mem_dread_pirate.25 }
            }
        }
        ELSE = {
            fromfrom.fleet = {
                clear_fleet_actions = this
            }
        }
    }
}

# Pop up telling us we taken down the ship
country_event = {
    id = mem_dread_pirate.25
    title = mem_dread_pirate.25.name
    desc = {
        text = mem_dread_pirate.25.desc.1
        trigger = {
            is_same_value = event_target:ship_killer
        }
    }
    desc = {
        text = mem_dread_pirate.25.desc.2
        trigger = {
            NOT = { is_same_value = event_target:ship_killer }
        }
    }

    is_triggered_only = yes

    location = event_target:dead_galleon
    show_sound = event_space_battle
    picture = GFX_evt_pirates_attacking_cargo

    option = {
        name = mem_dread_pirate.25.a
        enable_special_project = {
            name = MEM_DREAD_PIRATE_BOARDING_PROJECT
            location = event_target:dead_galleon
            owner = root
        }
    }
}

# Special project resolution
ship_event = {
    id = mem_dread_pirate.26
    title = mem_dread_pirate.26.name
    desc = mem_dread_pirate.26.desc

    is_triggered_only = yes

    location = event_target:dead_galleon
    show_sound = event_default
    picture = GFX_evt_mem_spaceship_wreck

    option = {
        name = mem_dread_pirate.26.a
        owner.capital_scope = {
            enable_special_project = {
                name = MEM_DREAD_PIRATE_TRIANGULATION_PROJECT
                location = event_target:dead_galleon
                owner = root
            }
        }
    }
}

# The final chapter resolution: Triangulation special project complete
country_event = {
    id = mem_dread_pirate.30
    title = mem_dread_pirate.30.name
    desc = mem_dread_pirate.30.desc

    is_triggered_only = yes

    show_sound = event_sensor_ping
    picture = GFX_evt_star_chart

    option = {
        name = mem_dread_pirate.30.a
    }
}

# TEST EVENT: Force-trigger a raid
country_event = {
    id = mem_dread_pirate.9999
    hide_window = yes
    is_triggered_only = yes

    trigger = {
        always = no
    }

    immediate = {
        random_relation = {
            limit = { 
                is_country_type = dormant_marauders
                has_communications = prev
                NOR = { 
                    has_country_flag = raid_ongoing
                    has_country_flag = raid_cooldown
                }
            }
            save_event_target_as = raiding_marauder
            species = { save_event_target_as = marauder_species }
        }
        country_event = { id = marauder.101 }
    }
}