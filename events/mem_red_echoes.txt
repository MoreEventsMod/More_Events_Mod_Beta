# Echoes of the Red
# Idea by whitewolf87
# Code by Z8MB1E

namespace = mem_red_echoes

# Soft Anomaly Failure (unused)
ship_event = {
    id = mem_red_echoes.1
    title = mem_red_echoes.1.name
    desc = mem_red_echoes.1.desc
    picture = GFX_evt_underground_civilization
    location = from
    show_sound = event_ship_bridge

    is_triggered_only = yes

    option = {
        name = mem_red_echoes.2.a
        fromfrom = {
            add_deposit = d_society_4
        }
    }
}

# "Echoes of the Red" digsite spawn event
ship_event = {
    id = mem_red_echoes.2
    title = mem_red_echoes.2.name
    desc = mem_red_echoes.2.desc
    picture = GFX_evt_underground_civilization
    location = fromfrom
    show_sound = event_dig_site
    
    is_triggered_only = yes
    
    immediate = {
        fromfrom = {
            set_planet_flag = mem_red_echoes_planet
            save_global_event_target_as = mem_red_echoes_planet
        }
        owner = {
            set_country_flag = mem_red_echoes
            set_variable = {
                which = mem_red_echoes_fail
                value = 0
            }
        }
    }

    option = {
        name = mem_red_echoes.2.a
        fromfrom = {
            create_archaeological_site = mem_red_echoes_digsite
        }
    }
}

# Stage 1: "Shaman of the Red"
fleet_event = {
    id = mem_red_echoes.3
    title = mem_red_echoes.3.name
    desc = mem_red_echoes.3.desc
    picture = GFX_evt_discovered_hidden_door
    show_sound = event_big_door_opening
    
    is_triggered_only = yes
    archaeology = yes

    immediate = {
        from = { set_site_progress_locked = yes }
        owner = {
            set_country_flag = mem_red_echoes_failure_01

            random_owned_planet = {
                limit = {
                    is_colony = yes
                }
                save_global_event_target_as = mem_red_echoes_random_planet
            }
        }
    }
    after = {
        from = { set_site_progress_locked = no }
    }

    option = {
        name = mem_red_echoes.3.a
        custom_tooltip = mem_red_echoes.3.a.tooltip
        small_artifact_reward = yes
    }
}

# "Shaman of the Red" failure event
fleet_event = {
    id = mem_red_echoes.4
    title = mem_red_echoes.4.name
    desc = mem_red_echoes.4.desc
    picture = GFX_evt_collapsing_roof
    show_sound = event_bad_omen

    fire_only_once = yes    
    is_triggered_only = yes
    
    immediate = {
        from = { set_site_progress_locked = yes }
    }
    after = {
        from = { set_site_progress_locked = no }
        hidden_effect = {
            owner = {
                change_variable = {
                    which = mem_red_echoes_fail
                    value = 1
                }
                # Fail Count: 1
            }
        }
    }

    option = {
        name = mem_red_echoes.4.a
        owner = {
            add_resource = {
                minor_artifacts = 1
            }
        }
    }
}

# Stage 2: "Lover of the Red"
fleet_event = {
    id = mem_red_echoes.5
    title = mem_red_echoes.5.name
    desc = mem_red_echoes.5.desc
    picture = GFX_evt_mem_lenin
    show_sound = event_big_door_opening

    is_triggered_only = yes
    archaeology = yes
    
    immediate = {
        from = { set_site_progress_locked = yes }
        owner = {
            set_country_flag = mem_red_echoes_failure_02

            random_owned_planet = {
                limit = {
                    is_colony = yes
                    OR = {
                        has_building = building_research_lab_1
                        has_building = building_research_lab_2
                        has_building = building_research_lab_3
                        has_building = building_private_research_initiative
                    }
                }
                save_global_event_target_as = mem_red_echoes_random_planet
            }
        }
    }
    after = {
        from = { set_site_progress_locked = no }
    }

    option = {
        name = mem_red_echoes.5.a
        custom_tooltip = mem_red_echoes.3.a.tooltip
        owner = {
            add_resource = {
                minor_artifacts = 3
                society_research = 200
            }
        }
    }
}

# "Lover of the Red" failure event 1
fleet_event = {
    id = mem_red_echoes.6
    title = mem_red_echoes.6.name
    desc = mem_red_echoes.6.desc
    picture = GFX_evt_interior_battle
    show_sound = event_screams

    fire_only_once = yes    
    is_triggered_only = yes
    
    immediate = {
        from = { set_site_progress_locked = yes }
    }
    after = {
        from = { set_site_progress_locked = no }
        owner = {
            change_variable = {
                which = mem_red_echoes_fail
                value = 1
            }
            # Fail Count: 2
        }
    }

    option = {
        name = mem_red_echoes.6.a
        custom_tooltip = mem_red_echoes.6.a.tooltip
        owner = {
            add_resource = {
                minor_artifacts = 1
            }
        }
        
        hidden_effect = {
            fromfrom = {
                add_stage_clues = -5
            }
            kill_leader = {
                show_notification = no
            }
        }
    }
}

# "Lover of the Red" failure event 2
fleet_event = {
    id = mem_red_echoes.7
    title = mem_red_echoes.7.name
    desc = mem_red_echoes.7.desc
    picture = GFX_evt_zro_5
    show_sound = event_whispering

    fire_only_once = yes    
    is_triggered_only = yes
    
    immediate = {
        from = { set_site_progress_locked = yes }
    }
    after = {
        from = { set_site_progress_locked = no }
        owner = {
            change_variable = {
                which = mem_red_echoes_fail
                value = 1
            }
            # Fail Count: 3
        }
    }

    option = {
        name = mem_red_echoes.7.a
        owner = {
            add_resource = {
                minor_artifacts = 1
            }
        }
        hidden_effect = {
            fromfrom = {
                add_stage_clues = -7
            }
        }
    }
}

# Stage 3: "You Can Still Go Home"
fleet_event = {
    id = mem_red_echoes.8
    title = mem_red_echoes.8.name
    desc = mem_red_echoes.8.desc
    picture = GFX_evt_underwater_ruins
    show_sound = event_mystic_reveal

    is_triggered_only = yes
    archaeology = yes
    
    immediate = {
        from = { set_site_progress_locked = yes }
        owner = {
            set_country_flag = mem_red_echoes_failure_03
        }
    }
    after = {
        from = { set_site_progress_locked = no }
    }

    option = {
        name = mem_red_echoes.8.a
        custom_tooltip = mem_red_echoes.8.a.tooltip
        owner = {
            add_resource = {
                society_research = 500
            }
        }
    }
}

# "You Can Still Go Home" failure event
fleet_event = {
    id = mem_red_echoes.9
    title = mem_red_echoes.9.name
    desc = mem_red_echoes.9.desc
    picture = GFX_evt_emergency_workers
    location = from
    show_sound = event_dangerous_animals
    
    fire_only_once = yes
    is_triggered_only = yes
    
    immediate = {
        from = { set_site_progress_locked = yes }
    }
    after = {
        from = { set_site_progress_locked = no }
        owner = {
            change_variable = {
                which = mem_red_echoes_fail
                value = 1
            }
            # Fail Count: 4
        }
    }

    option = {
        name = mem_red_echoes.9.a
        hidden_effect = {
            fromfrom = {
                add_stage_clues = -5
            }
        }
    }
}

# Final Stage: "The Bargain"
fleet_event = {
    id = mem_red_echoes.10
    title = mem_red_echoes.10.name
    desc = mem_red_echoes.10.desc
    picture = GFX_evt_warm_barren
    location = from
    show_sound = event_screams

    is_triggered_only = yes
    archaeology = yes

    option = {
        name = mem_red_echoes.10.a
        custom_tooltip = mem_red_echoes.10.a.tooltip

        hidden_effect = {
            owner = {
                kill_leader = {
                    type = ruler
                    show_notification = no
                }
            }
            destroy_fleet = {
                kill_leader = yes
                target = this
            }
            enable_special_project = {
                name = MEM_RED_ECHOES_INVESTIGATE_PROJECT
                location = event_target:mem_red_echoes_planet
            }
        }
    }
}

# Special Project: "Investigate Ghost Site"
ship_event = {
    id = mem_red_echoes.11
    title = mem_red_echoes.11.name
    desc = mem_red_echoes.11.desc
    picture = GFX_evt_mem_brainworm
    show_sound = event_whispering
    
    is_triggered_only = yes

    option = {
        name = mem_red_echoes.11.a
        # custom_tooltip = mem_red_echoes.11.a.tooltip

        owner = { 
            add_relic = r_mem_red_stone
            add_modifier = {
                modifier = mem_red_echoes_modifier
                days = -1
            }
        }
    }
}



# Failure event gatekeeper
# fleet_event = {
#     id = mem_red_echoes.99
#     hide_window = yes
    
#     is_triggered_only = yes

#     immediate = {
#         if = {
#             limit = {
#                 owner = {
#                     has_country_flag = mem_red_echoes_failure_01
#                 }
#             }
#             fleet_event = { id = mem_red_echoes.4 }
#         }
#         if = {
#             limit = {
#                 owner = {
#                     has_country_flag = mem_red_echoes_failure_02
#                 }
#             }
#             random_list = {
#                 10 = { fleet_event = { id = mem_red_echoes.6 } }
#                 10 = { fleet_event = { id = mem_red_echoes.7 } }
#             }
#         }
#         if = {
#             limit = {
#                 owner = {
#                     has_country_flag = mem_red_echoes_failure_03
#                 }
#             }
#             fleet_event = { id = mem_red_echoes.9 }
#         }
#     }
# }