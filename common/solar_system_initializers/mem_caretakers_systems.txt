mem_caretakers_system = {
    name = "Caretakers"
    class = "rl_standard_stars"
    asteroid_belt = {
		type = rocky_asteroid_belt
		radius = 150
    }
    asteroid_belt = {
		type = icy_asteroid_belt
		radius = 255
    }
    flags = { mem_caretakers_system }

    usage = misc_system_init
    usage_odds = {
        base = 9000
        modifier = {
            factor = 0
            NOT = {
                host_has_dlc = "Utopia"
            }
        }
    }
    max_instances = 1

    planet = {
        class = star
        orbit_distance = 0
    }

    change_orbit = 30

    planet = {
        count = 4
        orbit_distance = 25

        moon = {
            count = { min = 0 max = 1 }
            orbit_distance = 10
        }
    }

    change_orbit = 20

    planet = {
        count = { min = 2 max = 4 }
        size = { min = 4 max = 8 }
        orbit_distance = 0
        class = pc_asteroid
    }

    planet = {
        class = pc_gas_giant
        size = 25
        orbit_distance = 35
        flags = { mem_caretakers_gas_giant has_megastructure }

        init_effect = {
            prevent_anomaly = yes
            orbital_deposit_tile = { clear_deposits = yes }

            save_event_target_as = habitat_site
        }
    }

    planet = {
        class = pc_gas_giant
        size = 20
        orbit_distance = 35

        change_orbit = 5

        moon = {
            count = 3
            orbit_distance = 5
        }
    }

    change_orbit = 35

    planet = {
        count = { min = 2 max = 4 }
        size = { min = 4 max = 8 }
        orbit_distance = 0
        class = pc_ice_asteroid
    }

    planet = {
        count = { min = 1 max = 3 }
        orbit_distance = 35
        size = { min = 16 max = 20 }

        change_orbit = 5

        moon = {
            count = { min = 0 max = 2 }
            orbit_distance = 5
        }
    }

    init_effect = {
        spawn_planet = {
            class = pc_habitat
            location = event_target:habitat_site
            orbit_location = yes
            orbit_angle_offset = 45
            orbit_distance_offset = 9.899
            size = 12
            has_ring = no

            init_effect = {
                set_name = "Abandoned Habitat"
                set_planet_flag = mem_caretakers_habitat
                save_event_target_as = the_habitat
            }
        }
        event_target:the_habitat = {
            random_list = {
                1 = {
                    set_planet_entity = {
                        entity = "reptilian_01_orbital_habitat_entity"
                    }
                }
                1 = {
                    set_planet_entity = {
                        entity = "mammalian_01_orbital_habitat_entity"
                    }
                }
                1 = {
                    set_planet_entity = {
                        entity = "avian_01_orbital_habitat_entity"
                    }
                }
                1 = {
                    set_planet_entity = {
                        entity = "arthropoid_01_orbital_habitat_entity"
                    }
                }
                1 = {
                    set_planet_entity = {
                        entity = "molluscoid_01_orbital_habitat_entity"
                    }
                }
                1 = {
                    set_planet_entity = {
                        entity = "fungoid_01_orbital_habitat_entity"
                    }
                }
                1 = {
                    set_planet_entity = {
                        entity = "humanoid_01_orbital_habitat_entity"
                    }
                    modifier = {
                        factor = 0
                        NOT = { host_has_dlc = "Humanoids Species Pack" }
                    }
                }
                1 = {
                    set_planet_entity = {
                        entity = "plantoid_01_orbital_habitat_entity"
                    }
                    modifier = {
                        factor = 0
                        NOT = { host_has_dlc = "Plantoid" }
                    }
                }
            }
            while = {
                limit = {
                    any_tile = { has_blocker = yes }
                }
                random_tile = {
                    limit = { has_blocker = yes }
                    remove_blocker = yes
                }
            }
            set_planet_flag = megastructure
            set_planet_flag = habitat
            remove_orbital_deposit = yes
            
            #Caretaker spawning code
            create_species = {
                name = Caretaker
                adjective = Caretaker
                plural = Caretakers
                class = FUN
                portrait = fun3
                homeworld = this
                traits = {
                    trait = mem_caretakers_trait
                }
                sapient = no
            }
            while = {
                count = 3
                random_tile = {
                    limit = { has_pop = no has_blocker = no }
                    create_pop = { species = last_created }
                }
            }
            while = {
                count = 5
                random_tile = {
                    limit = { has_pop = no has_blocker = no }
                    set_blocker = tb_mem_caretakers_ruined_section
                }
            }
        }
    }
}
